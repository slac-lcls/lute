
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
        <meta name="author" content="GFD, VM">
      
      
      
        <link rel="prev" href="../../usage/running_lute/">
      
      
        <link rel="next" href="../creating_workflows/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.42">
    
    
      
        <title>Creating a new Task - LUTE</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.0253249f.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#integrating-a-new-task" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="LUTE" class="md-header__button md-logo" aria-label="LUTE" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            LUTE
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Creating a new Task
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/slac-lcls/lute" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="LUTE" class="md-nav__button md-logo" aria-label="LUTE" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    LUTE
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/slac-lcls/lute" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../quick_start/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Quick Start
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Usage Manual
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Usage Manual
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/configuration/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Task Configuration
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/running_lute/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Running LUTE
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Developer Documentation
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Developer Documentation
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Creating a new Task
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Creating a new Task
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#creating-a-third-party-task" class="md-nav__link">
    <span class="md-ellipsis">
      Creating a "Third-party" Task
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Creating a "Third-party" Task">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#specifying-a-taskparameters-model-for-your-task" class="md-nav__link">
    <span class="md-ellipsis">
      Specifying a TaskParameters Model for your Task
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Specifying a TaskParameters Model for your Task">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#faq" class="md-nav__link">
    <span class="md-ellipsis">
      FAQ
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#specifying-an-executor-creating-a-runnable-managed-task" class="md-nav__link">
    <span class="md-ellipsis">
      Specifying an Executor: Creating a runnable, "managed Task"
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Specifying an Executor: Creating a runnable, "managed Task"">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#parsing-inputs-and-outputs-tasklets" class="md-nav__link">
    <span class="md-ellipsis">
      Parsing inputs and outputs: tasklets
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Parsing inputs and outputs: tasklets">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#substituting-parameters-for-tasklet-arguments" class="md-nav__link">
    <span class="md-ellipsis">
      Substituting parameters for tasklet arguments
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#return-types-and-associated-actions" class="md-nav__link">
    <span class="md-ellipsis">
      Return types and associated actions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#examples" class="md-nav__link">
    <span class="md-ellipsis">
      Examples
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-templates-managing-third-party-configuration-files" class="md-nav__link">
    <span class="md-ellipsis">
      Using templates: managing third-party configuration files
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Using templates: managing third-party configuration files">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#non-validated-template-parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Non-validated template parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#validated-template-parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Validated template parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#additional-jinja-syntax" class="md-nav__link">
    <span class="md-ellipsis">
      Additional Jinja Syntax
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-a-first-party-task" class="md-nav__link">
    <span class="md-ellipsis">
      Creating a "First-Party" Task
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Creating a "First-Party" Task">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#specifying-a-taskparameters-model-for-your-task_1" class="md-nav__link">
    <span class="md-ellipsis">
      Specifying a TaskParameters Model for your Task
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#writing-the-task" class="md-nav__link">
    <span class="md-ellipsis">
      Writing the Task
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Writing the Task">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#using-mpi-for-your-task" class="md-nav__link">
    <span class="md-ellipsis">
      Using MPI for your Task
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#message-signals" class="md-nav__link">
    <span class="md-ellipsis">
      Message signals
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#making-your-task-available" class="md-nav__link">
    <span class="md-ellipsis">
      Making your Task available
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#defining-an-executor" class="md-nav__link">
    <span class="md-ellipsis">
      Defining an Executor
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Defining an Executor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#environment-setup" class="md-nav__link">
    <span class="md-ellipsis">
      Environment setup
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tasklet-usage" class="md-nav__link">
    <span class="md-ellipsis">
      tasklet usage
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../creating_workflows/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Creating a new Workflow
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Source Code
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Source Code
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../source/managed_tasks/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    managed_tasks
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2" >
        
          
          <label class="md-nav__link" for="__nav_4_2" id="__nav_4_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    execution
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_2">
            <span class="md-nav__icon md-icon"></span>
            execution
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../source/execution/executor/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    executor
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../source/execution/ipc/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ipc
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../source/execution/debug_utils/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    debug_utils
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../source/execution/logging/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    logging
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_3" >
        
          
          <label class="md-nav__link" for="__nav_4_3" id="__nav_4_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    tasks
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_3">
            <span class="md-nav__icon md-icon"></span>
            tasks
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../source/tasks/task/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    task
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../source/tasks/tasklets/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    tasklets
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../source/tasks/dataclasses/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    dataclasses
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../source/tasks/sfx_find_peaks/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    sfx_find_peaks
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../source/tasks/sfx_index/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    sfx_index
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../source/tasks/smalldata/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    smalldata
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../source/tasks/_smalldata/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    _smalldata
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../source/tasks/math/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    math
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../source/tasks/test/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    test
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../source/tasks/mpi_test/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    mpi_test
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_3_11" >
        
          
          <label class="md-nav__link" for="__nav_4_3_11" id="__nav_4_3_11_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    util
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_3_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_3_11">
            <span class="md-nav__icon md-icon"></span>
            util
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../source/tasks/util/html/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    html
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_4" >
        
          
          <label class="md-nav__link" for="__nav_4_4" id="__nav_4_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    io
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_4">
            <span class="md-nav__icon md-icon"></span>
            io
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_4_1" >
        
          
          <label class="md-nav__link" for="__nav_4_4_1" id="__nav_4_4_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    models
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_4_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_4_1">
            <span class="md-nav__icon md-icon"></span>
            models
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../source/io/models/base/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    base
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../source/io/models/sfx_find_peaks/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    sfx_find_peaks
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../source/io/models/sfx_index/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    sfx_index
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../source/io/models/sfx_merge/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    sfx_merge
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../source/io/models/sfx_solve/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    sfx_solve
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../source/io/models/smd/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    smd
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../source/io/models/validators/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    validators
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../source/io/models/tests/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    tests
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../source/io/models/mpi_tests/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    mpi_tests
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../source/io/config/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    config
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../source/io/db/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    db
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../source/io/_sqlite/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    _sqlite
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../source/io/elog/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    elog
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../source/io/exceptions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    exceptions
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Design and Specifications
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Design and Specifications
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../design/database/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Database
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#creating-a-third-party-task" class="md-nav__link">
    <span class="md-ellipsis">
      Creating a "Third-party" Task
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Creating a "Third-party" Task">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#specifying-a-taskparameters-model-for-your-task" class="md-nav__link">
    <span class="md-ellipsis">
      Specifying a TaskParameters Model for your Task
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Specifying a TaskParameters Model for your Task">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#faq" class="md-nav__link">
    <span class="md-ellipsis">
      FAQ
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#specifying-an-executor-creating-a-runnable-managed-task" class="md-nav__link">
    <span class="md-ellipsis">
      Specifying an Executor: Creating a runnable, "managed Task"
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Specifying an Executor: Creating a runnable, "managed Task"">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#parsing-inputs-and-outputs-tasklets" class="md-nav__link">
    <span class="md-ellipsis">
      Parsing inputs and outputs: tasklets
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Parsing inputs and outputs: tasklets">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#substituting-parameters-for-tasklet-arguments" class="md-nav__link">
    <span class="md-ellipsis">
      Substituting parameters for tasklet arguments
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#return-types-and-associated-actions" class="md-nav__link">
    <span class="md-ellipsis">
      Return types and associated actions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#examples" class="md-nav__link">
    <span class="md-ellipsis">
      Examples
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-templates-managing-third-party-configuration-files" class="md-nav__link">
    <span class="md-ellipsis">
      Using templates: managing third-party configuration files
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Using templates: managing third-party configuration files">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#non-validated-template-parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Non-validated template parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#validated-template-parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Validated template parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#additional-jinja-syntax" class="md-nav__link">
    <span class="md-ellipsis">
      Additional Jinja Syntax
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-a-first-party-task" class="md-nav__link">
    <span class="md-ellipsis">
      Creating a "First-Party" Task
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Creating a "First-Party" Task">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#specifying-a-taskparameters-model-for-your-task_1" class="md-nav__link">
    <span class="md-ellipsis">
      Specifying a TaskParameters Model for your Task
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#writing-the-task" class="md-nav__link">
    <span class="md-ellipsis">
      Writing the Task
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Writing the Task">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#using-mpi-for-your-task" class="md-nav__link">
    <span class="md-ellipsis">
      Using MPI for your Task
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#message-signals" class="md-nav__link">
    <span class="md-ellipsis">
      Message signals
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#making-your-task-available" class="md-nav__link">
    <span class="md-ellipsis">
      Making your Task available
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#defining-an-executor" class="md-nav__link">
    <span class="md-ellipsis">
      Defining an Executor
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Defining an Executor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#environment-setup" class="md-nav__link">
    <span class="md-ellipsis">
      Environment setup
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tasklet-usage" class="md-nav__link">
    <span class="md-ellipsis">
      tasklet usage
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="integrating-a-new-task">Integrating a New <code>Task</code></h1>
<p><code>Task</code>s can be broadly categorized into two types:</p>
<ul>
<li>"First-party" - where the analysis or executed code is maintained within this library.</li>
<li>"Third-party" - where the analysis, code, or program is maintained elsewhere and is simply called by a wrapping <code>Task</code>.</li>
</ul>
<p>Creating a new <code>Task</code> of either type generally involves the same steps, although for first-party <code>Task</code>s, the analysis code must of course also be written. Due to this difference, as well as additional considerations for parameter handling when dealing with "third-party" <code>Task</code>s, the "first-party" and "third-party" <code>Task</code> integration cases will be considered separately.</p>
<h2 id="creating-a-third-party-task">Creating a "Third-party" <code>Task</code></h2>
<p>There are two required steps for third-party <code>Task</code> integration, and one additional step which is optional, and may not be applicable to all possible third-party <code>Task</code>s. Generally, <code>Task</code> integration requires:</p>
<ol>
<li>Defining a <code>TaskParameters</code> (pydantic) model which fully parameterizes the <code>Task</code>. This involves specifying a path to a binary, and all the required command-line arguments to run the binary.</li>
<li>Creating a <strong>managed <code>Task</code></strong> by specifying an <code>Executor</code> for the new third-party <code>Task</code>. At this stage, any additional environment variables can be added which are required for the execution environment.</li>
<li><strong>(Optional/Maybe applicable)</strong> Create a template for a third-party configuration file. If the new <code>Task</code> has its own configuration file, specifying a template will allow that file to be parameterized from the singular LUTE yaml configuration file. A couple of minor additions to the <code>pydantic</code> model specified in 1. are required to support template usage.</li>
</ol>
<p>Each of these stages will be discussed in detail below. The vast majority of the work is completed in step 1.</p>
<h3 id="specifying-a-taskparameters-model-for-your-task">Specifying a <code>TaskParameters</code> Model for your <code>Task</code></h3>
<p>A brief overview of parameters objects will be provided below. The following information goes into detail only about specifics related to LUTE configuration. An in depth description of pydantic is beyond the scope of this tutorial; please refer to the <a href="https://docs.pydantic.dev/1.10/">official documentation</a> for more information. Please note that due to environment constraints pydantic is currently pinned to version 1.10! Make sure to read the appropriate documentation for this version as many things are different compared to the newer releases. At the end this document there will be an example highlighting some supported behaviour as well as a FAQ to address some common integration considerations.</p>
<p><strong><code>Task</code>s and <code>TaskParameter</code>s</strong></p>
<p>All <code>Task</code>s have a corresponding <code>TaskParameters</code> object. These objects are linked <strong>exclusively</strong> by a named relationship. For a <code>Task</code> named <code>MyThirdPartyTask</code>, the parameters object <strong>must</strong> be named <code>MyThirdPartyTaskParameters</code>. For third-party <code>Task</code>s there are a number of additional requirements:</p>
<ul>
<li>The model must inherit from a base class called <code>ThirdPartyParameters</code>.</li>
<li>The model must have one field specified called <code>executable</code>. The presence of this field indicates that the <code>Task</code> is a third-party <code>Task</code> and the specified executable must be called. This allows all third-party <code>Task</code>s to be defined exclusively by their parameters model. A single <code>ThirdPartyTask</code> class handles execution of <strong>all</strong> third-party <code>Task</code>s.</li>
</ul>
<p>All models are stored in <code>lute/io/models</code>. For any given <code>Task</code>, a new model can be added to an existing module contained in this directory or to a new module. If creating a new module, make sure to add an import statement to <code>lute.io.models.__init__</code>.</p>
<p><strong>Defining <code>TaskParameter</code>s</strong></p>
<p>When specifying parameters the default behaviour is to provide a one-to-one correspondance between the Python attribute specified in the parameter model, and the parameter specified on the command-line. Single-letter attributes are assumed to be passed using <code>-</code>, e.g. <code>n</code> will be passed as <code>-n</code> when the executable is launched. Longer attributes are passed using <code>--</code>, e.g. by default a model attribute named <code>my_arg</code> will be passed on the command-line as <code>--my_arg</code>. Positional arguments are specified using <code>p_argX</code> where <code>X</code> is a number. All parameters are passed in the order that they are specified in the model.</p>
<p>However, because the number of possible command-line combinations is large, relying on the default behaviour above is <strong>NOT recommended</strong>. It is provided solely as a fallback. Instead, there are a number of configuration knobs which can be tuned to achieve the desired behaviour. The two main mechanisms for controlling behaviour are specification of model-wide configuration under the <code>Config</code> class within the model's definition, and parameter-by-parameter configuration using field attributes. For the latter, we define all parameters as <code>Field</code> objects. This allows parameters to have their own attributes, which are parsed by LUTE's task-layer. Given this, the preferred starting template for a <code>TaskParameters</code> model is the following - we assume we are integrating a new <code>Task</code> called <code>RunTask</code>:</p>
<pre><code class="language-py">
from pydantic import Field, validator
# Also include any pydantic type specifications - Pydantic has many custom
# validation types already, e.g. types for constrained numberic values, URL handling, etc.

from .base import ThirdPartyParameters

# Change class name as necessary
class RunTaskParameters(ThirdPartyParameters):
    &quot;&quot;&quot;Parameters for RunTask...&quot;&quot;&quot;

    class Config(ThirdPartyParameters.Config): # MUST be exactly as written here.
        ...
        # Model-wide configuration will go here

    executable: str = Field(&quot;/path/to/executable&quot;, description=&quot;...&quot;)
    ...
    # Additional params.
    # param1: param1Type = Field(&quot;default&quot;, description=&quot;&quot;, ...)
</code></pre>
<p><strong>Config settings and options</strong>
Under the class definition for <code>Config</code> in the model, we can modify global options for all the parameters. In addition, there are a number of configuration options related to specifying what the outputs/results from the associated <code>Task</code> are, and a number of options to modify runtime behaviour. Currently, the available configuration options are:</p>
<table>
<thead>
<tr>
<th style="text-align: center;"><strong>Config Parameter</strong></th>
<th style="text-align: center;"><strong>Meaning</strong></th>
<th style="text-align: center;"><strong>Default Value</strong></th>
<th style="text-align: center;"><strong>ThirdPartyTask-specific?</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><code>run_directory</code></td>
<td style="text-align: center;">If provided, can be used to specify the directory from which a <code>Task</code> is run.</td>
<td style="text-align: center;"><code>None</code> (not provided)</td>
<td style="text-align: center;"><strong>NO</strong></td>
</tr>
<tr>
<td style="text-align: center;"><code>set_result</code></td>
<td style="text-align: center;"><code>bool</code>. If <code>True</code> search the model definition for a parameter that indicates what the result is.</td>
<td style="text-align: center;"><code>False</code></td>
<td style="text-align: center;"><strong>NO</strong></td>
</tr>
<tr>
<td style="text-align: center;"><code>result_from_params</code></td>
<td style="text-align: center;">If <code>set_result</code> is <code>True</code> can define a result using this option and a validator. See also <code>is_result</code> below.</td>
<td style="text-align: center;"><code>None</code> (not provided)</td>
<td style="text-align: center;"><strong>NO</strong></td>
</tr>
<tr>
<td style="text-align: center;"><code>short_flags_use_eq</code></td>
<td style="text-align: center;">Use equals sign instead of space for arguments of <code>-</code> parameters.</td>
<td style="text-align: center;"><code>False</code></td>
<td style="text-align: center;"><strong>YES</strong> - Only affects <code>ThirdPartyTask</code>s</td>
</tr>
<tr>
<td style="text-align: center;"><code>long_flags_use_eq</code></td>
<td style="text-align: center;">Use equals sign instead of space for arguments of <code>-</code> parameters.</td>
<td style="text-align: center;"><code>False</code></td>
<td style="text-align: center;"><strong>YES</strong> - Only affects <code>ThirdPartyTask</code>s</td>
</tr>
<tr>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
</tr>
</tbody>
</table>
<p>These configuration options modify how the parameter models are parsed and passed along on the command-line, as well as what we consider results and where a <code>Task</code> can run. The default behaviour is that parameters are assumed to be passed as <code>-p arg</code> and <code>--param arg</code>, the <code>Task</code> will be run in the current working directory (or scratch if submitted with the ARP), and we have no information about <code>Task</code> results . Setting the above options can modify this behaviour.</p>
<ul>
<li>By setting <code>short_flags_use_eq</code> and/or <code>long_flags_use_eq</code> to <code>True</code> parameters are instead passed as <code>-p=arg</code> and <code>--param=arg</code>.</li>
<li>By setting <code>run_directory</code> to a valid path, we can force a <code>Task</code> to be run in a specific directory. By default the <code>Task</code> will be run from the directory you submit the job in, or from your scratch folder (<code>/sdf/scratch/...</code>) if you submit from the eLog. Some <code>ThirdPartyTask</code>s rely on searching the correct working directory in order run properly.</li>
<li>By setting <code>set_result</code> to <code>True</code> we indicate that the <code>TaskParameters</code> model will provide information on what the <code>TaskResult</code> is. This setting must be used with one of two options, either the <code>result_from_params</code> <code>Config</code> option, described below, or the <strong>Field</strong> attribute <code>is_result</code> described in the next sub-section (<strong>Field Attributes</strong>).</li>
<li><code>result_from_params</code> is a Config option that can be used when <code>set_result==True</code>. In conjunction with a <strong>validator</strong> (described a sections down) we can use this option to specify a result from all the information contained in the model. E.g. if you have a <code>Task</code> that has parameters for an <code>output_directory</code> and a <code>output_filename</code>, you can set <code>result_from_params==f"{output_directory}/{output_filename}"</code>.</li>
</ul>
<p><strong>Field attributes</strong>
In addition to the global configuration options there are a couple of ways to specify individual parameters. The following <code>Field</code> attributes are used when parsing the model:</p>
<table>
<thead>
<tr>
<th style="text-align: center;"><strong>Field Attribute</strong></th>
<th style="text-align: center;"><strong>Meaning</strong></th>
<th style="text-align: center;"><strong>Default Value</strong></th>
<th style="text-align: center;"><strong>Example</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><code>flag_type</code></td>
<td style="text-align: center;">Specify the type of flag for passing this argument. One of <code>"-"</code>, <code>"--"</code>, or <code>""</code></td>
<td style="text-align: center;">N/A</td>
<td style="text-align: center;"><code>p_arg1 = Field(..., flag_type="")</code></td>
</tr>
<tr>
<td style="text-align: center;"><code>rename_param</code></td>
<td style="text-align: center;">Change the name of the parameter as passed on the command-line.</td>
<td style="text-align: center;">N/A</td>
<td style="text-align: center;"><code>my_arg = Field(..., rename_param="my-arg")</code></td>
</tr>
<tr>
<td style="text-align: center;"><code>description</code></td>
<td style="text-align: center;">Documentation of the parameter's usage or purpose.</td>
<td style="text-align: center;">N/A</td>
<td style="text-align: center;"><code>arg = Field(..., description="Argument for...")</code></td>
</tr>
<tr>
<td style="text-align: center;"><code>is_result</code></td>
<td style="text-align: center;"><code>bool</code>. If the <code>set_result</code> <code>Config</code> option is <code>True</code>, we can set this to <code>True</code> to indicate a result.</td>
<td style="text-align: center;">N/A</td>
<td style="text-align: center;"><code>output_result = Field(..., is_result=true)</code></td>
</tr>
<tr>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
</tr>
</tbody>
</table>
<p>The <code>flag_type</code> attribute allows us to specify whether the parameter corresponds to a positional (<code>""</code>) command line argument, requires a single hyphen (<code>"-"</code>), or a double hyphen (<code>"--"</code>). By default, the parameter name is passed as-is on the command-line. However, command-line arguments can have characters which would not be valid in Python variable names. In particular, hyphens are frequently used. To handle this case, the <code>rename_param</code> attribute can be used to specify an alternative spelling of the parameter when it is passed on the command-line. This also allows for using more descriptive variable names internally than those used on the command-line. A <code>description</code> can also be provided for each Field to document the usage and purpose of that particular parameter.</p>
<p>As an example, we can again consider defining a model for a <code>RunTask</code> <code>Task</code>. Consider an executable which would normally be called from the command-line as follows:</p>
<pre><code class="language-bash">/sdf/group/lcls/ds/tools/runtask -n &lt;nthreads&gt; --method=&lt;algorithm&gt; -p &lt;algo_param&gt; [--debug]
</code></pre>
<p>A model specification for this <code>Task</code> may look like:</p>
<pre><code class="language-py">class RunTaskParameters(ThirdPartyParameters):
    &quot;&quot;&quot;Parameters for the runtask binary.&quot;&quot;&quot;

    class Config(ThirdPartyParameters.Config):
        long_flags_use_eq: bool = True  # For the --method parameter

    # Prefer using full/absolute paths where possible.
    # No flag_type needed for this field
    executable: str = Field(
        &quot;/sdf/group/lcls/ds/tools/runtask&quot;, description=&quot;Runtask Binary v1.0&quot;
    )

    # We can provide a more descriptive name for -n
    # Let's assume it's a number of threads, or processes, etc.
    num_threads: int = Field(
        1, description=&quot;Number of concurrent threads.&quot;, flag_type=&quot;-&quot;, rename_param=&quot;n&quot;
    )

    # In this case we will use the Python variable name directly when passing
    # the parameter on the command-line
    method: str = Field(&quot;algo1&quot;, description=&quot;Algorithm to use.&quot;, flag_type=&quot;--&quot;)

    # For an actual parameter we would probably have a better name. Lets assume
    # This parameter (-p) modifies the behaviour of the method above.
    method_param1: int = Field(
        3, description=&quot;Modify method performance.&quot;, flag_type=&quot;-&quot;, rename_param=&quot;p&quot;
    )

    # Boolean flags are only passed when True! `--debug` is an optional parameter
    # which is not followed by any arguments.
    debug: bool = Field(
        False, description=&quot;Whether to run in debug mode.&quot;, flag_type=&quot;--&quot;
    )
</code></pre>
<p>The <code>is_result</code> attribute allows us to specify whether the corresponding Field points to the output/result of the associated <code>Task</code>. Consider a <code>Task</code>, <code>RunTask2</code> which writes its output to a single file which is passed as a parameter.</p>
<pre><code class="language-py">class RunTask2Parameters(ThirdPartyParameters):
    &quot;&quot;&quot;Parameters for the runtask2 binary.&quot;&quot;&quot;

    class Config(ThirdPartyParameters.Config):
        set_result: bool = True                     # This must be set here!
        # result_from_params: Optional[str] = None  # We can use this for more complex result setups (see below). Ignore for now.

    # Prefer using full/absolute paths where possible.
    # No flag_type needed for this field
    executable: str = Field(
        &quot;/sdf/group/lcls/ds/tools/runtask2&quot;, description=&quot;Runtask Binary v2.0&quot;
    )

    # Lets assume we take one input and write one output file
    # We will not provide a default value, so this parameter MUST be provided
    input: str = Field(
        description=&quot;Path to input file.&quot;, flag_type=&quot;--&quot;
    )

    # We will also not provide a default for the output
    # BUT, we will specify that whatever is provided is the result
    output: str = Field(
        description=&quot;Path to write output to.&quot;,
        flag_type=&quot;-&quot;,
        rename_param=&quot;o&quot;,
        is_result=True,   # This means this parameter points to the result!
    )
</code></pre>
<p><strong>Additional Comments</strong></p>
<ol>
<li>Model parameters of type <code>bool</code> are not passed with an argument and are only passed when <code>True</code>. This is a common use-case for boolean flags which enable things like test or debug modes, verbosity or reporting features. E.g. <code>--debug</code>, <code>--test</code>, <code>--verbose</code>, etc.</li>
<li>If you need to pass the literal words <code>"True"</code> or <code>"False"</code>, use a parameter of type <code>str</code>.</li>
<li>You can use <code>pydantic</code> types to constrain parameters beyond the basic Python types. E.g. <code>conint</code> can be used to define lower and upper bounds for an integer. There are also types for common categories, positive/negative numbers, paths, URLs, IP addresses, etc.</li>
<li>Even more custom behaviour can be achieved with <code>validator</code>s (see below).</li>
<li>All <code>TaskParameters</code> objects and its subclasses have access to a <code>lute_config</code> parameter, which is of type <code>lute.io.models.base.AnalysisHeader</code>. This special parameter is ignored when constructing the call for a binary task, but it provides access to shared/common parameters between tasks. For example, the following parameters are available through the <code>lute_config</code> object, and may be of use when constructing validators. All fields can be accessed with <code>.</code> notation. E.g. <code>lute_config.experiment</code>.</li>
<li><code>title</code>: A user provided title/description of the analysis.</li>
<li><code>experiment</code>: The current experiment name</li>
<li><code>run</code>: The current acquisition run number</li>
<li><code>date</code>: The date of the experiment or the analysis.</li>
<li><code>lute_version</code>: The version of the software you are running.</li>
<li><code>task_timeout</code>: How long a <code>Task</code> can run before it is killed.</li>
<li><code>work_dir</code>: The main working directory for LUTE. Files and the database are created relative to this directory. This is separate from the <code>run_directory</code> config option. LUTE will write files to the work directory by default; however, the <code>Task</code> itself is run from <code>run_directory</code> if it is specified.</li>
</ol>
<p><strong>Validators</strong>
Pydantic uses <code>validators</code> to determine whether a value for a specific field is appropriate. There are default validators for all the standard library types and the types specified within the pydantic package; however, it is straightforward to define custom ones as well. In the template code-snippet above we imported the <code>validator</code> decorator. To create our own validator we define a method (with any name) with the following prototype, and decorate it with the <code>validator</code> decorator:</p>
<pre><code class="language-py">@validator(&quot;name_of_field_to_decorate&quot;)
def my_custom_validator(cls, field: Any, values: Dict[str, Any]) -&gt; Any: ...
</code></pre>
<p>In this snippet, the <code>field</code> variable corresponds to the value for the specific field we want to validate. <code>values</code> is a dictionary of fields and their values which have been parsed prior to the current field. This means you can validate the value of a parameter based on the values provided for other parameters. Since pydantic always validates the fields in the order they are defined in the model, fields dependent on other fields should come later in the definition.</p>
<p>For example, consider the <code>method_param1</code> field defined above for <code>RunTask</code>. We can provide a custom validator which changes the default value for this field depending on what type of algorithm is specified for the <code>--method</code> option. We will also constrain the options for <code>method</code> to two specific strings.</p>
<pre><code class="language-py">from pydantic import Field, validator, ValidationError, root_validator
class RunTaskParameters(ThirdPartyParameters):
    &quot;&quot;&quot;Parameters for the runtask binary.&quot;&quot;&quot;

    # [...]

    # In this case we will use the Python variable name directly when passing
    # the parameter on the command-line
    method: str = Field(&quot;algo1&quot;, description=&quot;Algorithm to use.&quot;, flag_type=&quot;--&quot;)

    # For an actual parameter we would probably have a better name. Lets assume
    # This parameter (-p) modifies the behaviour of the method above.
    method_param1: Optional[int] = Field(
        description=&quot;Modify method performance.&quot;, flag_type=&quot;-&quot;, rename_param=&quot;p&quot;
    )

    # We will only allow method to take on one of two values
    @validator(&quot;method&quot;)
    def validate_method(cls, method: str, values: Dict[str, Any]) -&gt; str:
        &quot;&quot;&quot;Method validator: --method can be algo1 or algo2.&quot;&quot;&quot;

        valid_methods: List[str] = [&quot;algo1&quot;, &quot;algo2&quot;]
        if method not in valid_methods:
            raise ValueError(&quot;method must be algo1 or algo2&quot;)
        return method

    # Lets change the default value of `method_param1` depending on `method`
    # NOTE: We didn't provide a default value to the Field above and made it
    # optional. We can use this to test whether someone is purposefully
    # overriding the value of it, and if not, set the default ourselves.
    # We set `always=True` since pydantic will normally not use the validator
    # if the default is not changed
    @validator(&quot;method_param1&quot;, always=True)
    def validate_method_param1(cls, param1: Optional[int], values: Dict[str, Any]) -&gt; int:
        &quot;&quot;&quot;method param1 validator&quot;&quot;&quot;

        # If someone actively defined it, lets just return that value
        # We could instead do some additional validation to make sure that the
        # value they provided is valid...
        if param1 is not None:
            return param1

        # method_param1 comes after method, so this will be defined, or an error
        # would have been raised.
        method: str = values['method']
        if method == &quot;algo1&quot;:
            return 3
        elif method == &quot;algo2&quot;:
            return 5
</code></pre>
<p>The special <code>root_validator(pre=False)</code> can also be used to provide validation of the model as a whole. This is also the recommended method for specifying a result (using <code>result_from_params</code>) which has a complex dependence on the parameters of the model. This latter use-case is described in FAQ 2 below.</p>
<h4 id="faq">FAQ</h4>
<ol>
<li>How can I specify a default value which depends on another parameter?</li>
</ol>
<p>Use a custom validator. The example above shows how to do this. The parameter that depends on another parameter must come LATER in the model defintion than the independent parameter.</p>
<ol>
<li>My <code>TaskResult</code> is determinable from the parameters model, but it isn't easily specified by one parameter. How can I use <code>result_from_params</code> to indicate the result?</li>
</ol>
<p>When a result can be identified from the set of parameters defined in a <code>TaskParameters</code> model, but is not as straightforward as saying it is equivalent to one of the parameters alone, we can set <code>result_from_params</code> using a custom validator. In the example below, we have two parameters which together determine what the result is, <code>output_dir</code> and <code>out_name</code>. Using a validator we will define a result from these two values.</p>
<pre><code class="language-py">from pydantic import Field, root_validator

class RunTask3Parameters(ThirdPartyParameters):
    &quot;&quot;&quot;Parameters for the runtask3 binary.&quot;&quot;&quot;

    class Config(ThirdPartyParameters.Config):
        set_result: bool = True       # This must be set here!
        result_from_params: str = &quot;&quot;  # We will set this momentarily

    # [...] executable, other params, etc.

    output_dir: str = Field(
        description=&quot;Directory to write output to.&quot;,
        flag_type=&quot;--&quot;,
        rename_param=&quot;dir&quot;,
    )

    out_name: str = Field(
        description=&quot;The name of the final output file.&quot;,
        flag_type=&quot;--&quot;,
        rename_param=&quot;oname&quot;,
    )

    # We can still provide other validators as needed
    # But for now, we just set result_from_params
    # Validator name can be anything, we set pre=False so this runs at the end
    @root_validator(pre=False)
    def define_result(cls, values: Dict[str, Any]) -&gt; Dict[str, Any]:
        # Extract the values of output_dir and out_name
        output_dir: str = values[&quot;output_dir&quot;]
        out_name: str = values[&quot;out_name&quot;]

        result: str = f&quot;{output_dir}/{out_name}&quot;
        # Now we set result_from_params
        cls.Config.result_from_params = result

        # We haven't modified any other values, but we MUST return this!
        return values
</code></pre>
<ol>
<li>My new <code>Task</code> depends on the output of a previous <code>Task</code>, how can I specify this dependency?
Parameters used to run a <code>Task</code> are recorded in a database for every <code>Task</code>. It is also recorded whether or not the execution of that specific parameter set was successful. A utility function is provided to access the most recent values from the database for a specific parameter of a specific <code>Task</code>. It can also be used to specify whether unsuccessful <code>Task</code>s should be included in the query. This utility can be used within a validator to specify dependencies. For example, suppose the input of <code>RunTask2</code> (parameter <code>input</code>) depends on the output location of <code>RunTask1</code> (parameter <code>outfile</code>). A validator of the following type can be used to retrieve the output file and make it the default value of the input parameter.</li>
</ol>
<pre><code class="language-py">from pydantic import Field, validator

from .base import ThirdPartyParameters
from ..db import read_latest_db_entry

class RunTask2Parameters(ThirdPartyParameters):
    input: str = Field(&quot;&quot;, description=&quot;Input file.&quot;, flag_type=&quot;--&quot;)

    @validator(&quot;input&quot;)
    def validate_input(cls, input: str, values: Dict[str, Any]) -&gt; str:
        if input == &quot;&quot;:
            task1_out: Optional[str] = read_latest_db_entry(
                f&quot;{values['lute_config'].work_dir}&quot;,  # Working directory. We search for the database here.
                &quot;RunTask1&quot;,                           # Name of Task we want to look up
                &quot;outfile&quot;,                            # Name of parameter of the Task
                valid_only=True,                      # We only want valid output files.
            )
            # read_latest_db_entry returns None if nothing is found
            if task1_out is not None:
                return task1_out
        return input
</code></pre>
<p>There are more examples of this pattern spread throughout the various <code>Task</code> models.</p>
<h3 id="specifying-an-executor-creating-a-runnable-managed-task">Specifying an <code>Executor</code>: Creating a runnable, "managed <code>Task</code>"</h3>
<p><strong>Overview</strong></p>
<p>After a pydantic model has been created, the next required step is to define a <strong>managed <code>Task</code></strong>. In the context of this library, a <strong>managed <code>Task</code></strong> refers to the combination of an <code>Executor</code> and a <code>Task</code> to run. The <code>Executor</code> manages the process of <code>Task</code> submission and the execution environment, as well as performing any logging, eLog communication, etc. There are currently two types of <code>Executor</code> to choose from, <strong>but only one is applicable to third-party code.</strong> The second <code>Executor</code> is listed below for completeness only. If you need MPI see the note below.</p>
<ol>
<li><code>Executor</code>: This is the standard <code>Executor</code>. It should be used for third-party uses cases.</li>
<li>
<p><code>MPIExecutor</code>: This performs all the same types of operations as the option above; however, it will submit your <code>Task</code> using MPI.</p>
</li>
<li>
<p>The <code>MPIExecutor</code> will submit the <code>Task</code> using the number of available cores - 1. The number of cores is determined from the physical core/thread count on your local machine, or the number of cores allocated by SLURM when submitting on the batch nodes.</p>
</li>
</ol>
<p><strong>Using MPI with third-party <code>Task</code>s</strong></p>
<p>As mentioned, you should setup a third-party <code>Task</code> to use the first type of <code>Executor</code>. If, however, your third-party <code>Task</code> uses MPI this may seem non-intuitive. When using the <code>MPIExecutor</code> LUTE code is submitted with MPI. This includes the code that performs signalling to the <code>Executor</code> and <code>exec</code>s the third-party code you are interested in running. While it is possible to set this code up to run with MPI, it is more challenging in the case of third-party <code>Task</code>s because there is no <code>Task</code> code to modify directly! The <code>MPIExecutor</code> is provided mostly for first-party code. This is not an issue, however, since the standard <code>Executor</code> is easily configured to run with MPI in the case of third-party code.</p>
<p>When using the standard <code>Executor</code> for a <code>Task</code> requiring MPI, the <code>executable</code> in the pydantic model must be set to <code>mpirun</code>. For example, a third-party <code>Task</code> model, that uses MPI but is intended to be run with the <code>Executor</code> may look like the following. We assume this <code>Task</code> runs a Python script using MPI.</p>
<pre><code class="language-py">class RunMPITaskParameters(ThirdPartyParameters):
    class Config(ThirdPartyParameters.Config):
        ...

    executable: str = Field(&quot;mpirun&quot;, description=&quot;MPI executable&quot;)
    np: PositiveInt = Field(
        max(int(os.environ.get(&quot;SLURM_NPROCS&quot;, len(os.sched_getaffinity(0)))) - 1, 1),
        description=&quot;Number of processes&quot;,
        flag_type=&quot;-&quot;,
    )
    pos_arg: str = Field(&quot;python&quot;, description=&quot;Python...&quot;, flag_type=&quot;&quot;)
    script: str = Field(&quot;&quot;, description=&quot;Python script to run with MPI&quot;, flag_type=&quot;&quot;)
</code></pre>
<p><strong>Selecting the <code>Executor</code></strong></p>
<p>After deciding on which <code>Executor</code> to use, a single line must be added to the <code>lute/managed_tasks.py</code> module:</p>
<pre><code class="language-py"># Initialization: Executor(&quot;TaskName&quot;)
TaskRunner: Executor = Executor(&quot;SubmitTask&quot;)
# TaskRunner: MPIExecutor = MPIExecutor(&quot;SubmitTask&quot;) ## If using the MPIExecutor
</code></pre>
<p>In an attempt to make it easier to discern whether discussing a <code>Task</code> or <strong>managed <code>Task</code></strong>, the standard naming convention is that the <code>Task</code> (class name) will have a verb in the name, e.g. <code>RunTask</code>, <code>SubmitTask</code>. The corresponding <strong>managed <code>Task</code></strong> will use a related noun, e.g. <code>TaskRunner</code>, <code>TaskSubmitter</code>, etc.</p>
<p>As a reminder, the <code>Task</code> name is the first part of the class name of the pydantic model, without the <code>Parameters</code> suffix. This name <strong>must</strong> match. E.g. if your pydantic model's class name is <code>RunTaskParameters</code>, the <code>Task</code> name is <code>RunTask</code>, and this is the string passed to the <code>Executor</code> initializer.</p>
<p><strong>Modifying the environment</strong></p>
<p>If your third-party <code>Task</code> can run in the standard <code>psana</code> environment with no further configuration files, the setup process is now complete and your <code>Task</code> can be run within the LUTE framework. If on the other hand your <code>Task</code> requires some changes to the environment, this is managed through the <code>Executor</code>. There are a couple principle methods that the <code>Executor</code> has to change the environment.</p>
<ol>
<li><code>Executor.update_environment</code>: if you only need to add a few environment variables, or update the <code>PATH</code> this is the method to use. The method takes a <code>Dict[str, str]</code> as input. Any variables can be passed/defined using this method. By default, any variables in the dictionary will overwrite those variable definitions in the current environment if they are already present, <strong>except</strong> for the variable <code>PATH</code>. By default <code>PATH</code> entries in the dictionary are prepended to the current <code>PATH</code> available in the environment the <code>Executor</code> runs in (the standard <code>psana</code> environment). This behaviour can be changed to either append, or overwrite the <code>PATH</code> entirely by an optional second argument to the method.</li>
<li><code>Executor.shell_source</code>: This method will source a shell script which can perform numerous modifications of the environment (PATH changes, new environment variables, conda environments, etc.). The method takes a <code>str</code> which is the path to a shell script to source.</li>
</ol>
<p>As an example, we will update the <code>PATH</code> of one <code>Task</code> and source a script for a second.</p>
<pre><code class="language-py">TaskRunner: Executor = Executor(&quot;RunTask&quot;)
# update_environment(env: Dict[str,str], update_path: str = &quot;prepend&quot;) # &quot;append&quot; or &quot;overwrite&quot;
TaskRunner.update_environment(
    { &quot;PATH&quot;: &quot;/sdf/group/lcls/ds/tools&quot; }  # This entry will be prepended to the PATH available after sourcing `psconda.sh`
)

Task2Runner: Executor = Executor(&quot;RunTask2&quot;)
Task2Runner.shell_source(&quot;/sdf/group/lcls/ds/tools/new_task_setup.sh&quot;) # Will source new_task_setup.sh script
</code></pre>
<h4 id="parsing-inputs-and-outputs-tasklets">Parsing inputs and outputs: <code>tasklets</code></h4>
<p>Generally, in addition to the final output from the <code>Task</code>, we are also interested in some summary information. This could be a text summary of some key result in the larger output, or a graphical figure that describes the portions of interest.</p>
<p>For a third-party <code>Task</code> there isn't an easy way to insert code that provides these summaries into the <code>Task</code> itself, so the <code>tasklet</code> mechanism is provided. Tasklets are just Python functions. They are executed by the <code>Executor</code> either before or after the main <code>Task</code> has been run. One major use case of tasklets, is that the <code>Executor</code> can use the return values from these functions as the summary information for the main <code>Task</code> they are associated with. Tasklets are added to the <code>Executor</code> in much the same way that the execution environment is modified: using the <code>add_tasklet</code> method. E.g.</p>
<pre><code class="language-py">Task3Runner: Executor = Executor(&quot;RunTask3&quot;)
Task3Runner.add_tasklet(
    callable,
    [arg1, arg2, arg3],
    when=&quot;before&quot;,
    set_result=False,
    set_summary=True
)
</code></pre>
<p>The <code>add_tasklet</code> method has the following signature:</p>
<pre><code class="language-py">def add_tasklet(
    self,
    tasklet: Callable,
    args: Union[List[Any], Tuple[Any,...]],
    when: str,
    set_result: bool,
    set_summary: bool
)
</code></pre>
<p>These parameters, in order, are:</p>
<ul>
<li><code>tasklet</code> : Any callable function. A number of tasklets are already defined in the <code>lute.tasks.tasklets</code> module as examples. Some of these are already associated with <strong>managed</strong> <code>Task</code>s.</li>
<li><code>args</code> : This is a list/tuple (or any iterable) of arguments to pass to the <code>tasklet</code>. The arguments can be substituted similarly to templates (below) or parameters in the configuration YAML. This is discussed further below.</li>
<li><code>when</code>: This is a string literal taking the values of <code>"before"</code> or <code>"after"</code>, indicating whether the tasklet function should be run before or after the actual <code>Task</code>, respectively.</li>
<li><code>set_result</code>: Is a bool. If <code>True</code>, the <strong>main result payload</strong> will be overwritten in the database with the return values of the tasklet. This affects only the database archiving - any actual files, etc., will not be overwritten. Regardless, in general this is not the appropriate option to use with a third-party <code>Task</code>.</li>
<li><code>set_summary</code>: Is a bool. If <code>True</code>, the <strong>result summary</strong> is set to the return values of the tasklet. This allows the main result of the <code>Task</code> to be recorded in addition to some auxiliary summary information. In general, we will want to use this option.</li>
</ul>
<h5 id="substituting-parameters-for-tasklet-arguments">Substituting parameters for <code>tasklet</code> arguments</h5>
<p>We often want the input to a tasklet to depend on some of the <code>TaskParameters</code> for the main associated <code>Task</code>. We can specify this using a Jinja-like substitution syntax. When passing arguments to the <code>add_tasklet</code> method, we can enclose the name of parameters from the <code>TaskParameters</code> model in a string between doubly curly brackets: <code>"{{ param_to_sub }}"</code>. For example if we wanted to use the output file as the input to the tasklet, assuming it had the parameter name <code>out_file</code>, we would use <code>"{{ out_file }}"</code>.</p>
<p>You can substitute multiple parameters in every string if necessary, with each parameter to substitute enclosed in its own set of double curly brackets.</p>
<p><strong>Note:</strong> The parameter substitutions must be passed as strings. Type conversions will be performed to the actual type of the parameter you are substituting.</p>
<h5 id="return-types-and-associated-actions">Return types and associated actions</h5>
<p>The <code>Executor</code> will decide on what to do with a returned value from a tasklet based upon the specific type. Note that these types can also be used in first-party <code>Task</code>s to perform the same actions; however, in that case, users should set the <code>_result.summary</code> or <code>_result.payload</code> directly, rather than using a tasklet (if possible).</p>
<p>The following types and actions are currently defined:</p>
<ul>
<li><code>Dict[str, str]</code>: Post key/value pairs under the report section in the control tab of the eLog. These key/values are also posted as run parameters if possible. This return type is best used for short text summaries, e.g. indexing rate, execution time, etc. The key/value pairs are converted to a semi-colon delimited string for storage in the database. E.g. <code>{"Rate": 0.05, "Total": 10}</code> will be stored as <code>Rate: 0.05;Total: 10</code> in the database.</li>
<li><code>ElogSummaryPlots</code>: This special dataclass, defined in <code>lute.tasks.dataclasses</code> is used to create an eLog summary plot under the Summaries tab. The path to the created HTML file is stored in the database.</li>
</ul>
<p>You can return any number of these objects from a tasklet as a tuple. Each item will be processed independently. For datbase archiving, the various entries are stored semi-colon delimited.</p>
<h5 id="examples">Examples</h5>
<p>Some example <code>tasklets</code> are available in <code>lute.tasks.tasklets</code>. Some of these are reproduced below.</p>
<p><strong>Generic Usage</strong></p>
<ul>
<li><code>concat_files(location: str, in_files_glob: str, out_file: str)</code>: Concatenate a set of output files</li>
<li><code>grep(match_str: str, in_file: str)</code>: Search for occurences of a string in some output file.</li>
<li><code>git_clone(repo: str, location: str, permissions: str)</code>: Clone a git repository. This is generally of more use as a tasklet run <strong>before</strong> the main <code>Task</code> is run.</li>
</ul>
<p><strong>Specific Examples</strong></p>
<ul>
<li><code>indexamajig_summary_indexing_rate</code>: Calculates indexing rate based on parsing a stream file.</li>
<li><code>compare_hkl_fom_summary</code>: Extracts a figure of merit <strong>and</strong> produces a summary plot.</li>
</ul>
<p>Refer to <code>managed_tasks</code> to see how these are specifically called with <code>CrystFELIndexer</code> and <code>HKLComparer</code> respectively.</p>
<h3 id="using-templates-managing-third-party-configuration-files">Using templates: managing third-party configuration files</h3>
<p>Some third-party executables will require their own configuration files. These are often separate JSON or YAML files, although they can also be bash or Python scripts which are intended to be edited. Since LUTE requires its own configuration YAML file, it attempts to handle these cases by using Jinja templates. When wrapping a third-party task a template can also be provided - with small modifications to the <code>Task</code>'s pydantic model, LUTE can process special types of parameters to render them in the template. LUTE offloads all the template rendering to Jinja, making the required additions to the pydantic model small. On the other hand, it does require understanding the Jinja syntax, and the provision of a well-formatted template, to properly parse parameters. Some basic examples of this syntax will be shown below; however, it is recommended that the <code>Task</code> implementer refer to the <a href="https://jinja.palletsprojects.com/en/3.1.x/">official Jinja documentation</a> for more information.</p>
<p><strong>Note:</strong> By default templated parameters are <strong>NOT</strong> validated, i.e., type-checked. This default case is handled first below. If knowledgeable about appropriate typing for the template variables, further modification of the <code>TaskParameters</code> model is possible to include validation. This advanced use-case is described second.</p>
<h4 id="non-validated-template-parameters">Non-validated template parameters</h4>
<p>LUTE provides two additional base models which are used for template parsing in conjunction with the primary <code>Task</code> model. These are:</p>
<ul>
<li><code>TemplateParameters</code> objects which hold parameters which will be used to render a portion of a template.</li>
<li><code>TemplateConfig</code> objects which hold two strings: the name of the template file to use and the full path (including filename) of where to output the rendered result.</li>
</ul>
<p><code>Task</code> models which inherit from the <code>ThirdPartyParameters</code> model, as all third-party <code>Task</code>s should, allow for extra arguments. LUTE will parse any extra arguments provided in the configuration YAML as <code>TemplateParameters</code> objects automatically, which means that they do not need to be explicitly added to the pydantic model (although they can be). As such the <strong>only</strong> requirement on the Python-side when adding template rendering functionality to the <code>Task</code> is the addition of one parameter - an instance of <code>TemplateConfig</code>. The instance <strong>MUST</strong> be called <code>lute_template_cfg</code>.</p>
<pre><code class="language-py">from pydantic import Field, validator

from .base import TemplateConfig

class RunTaskParamaters(ThirdPartyParameters):
    ...
    # This parameter MUST be called lute_template_cfg!
    lute_template_cfg: TemplateConfig = Field(
        TemplateConfig(
            template_name=&quot;name_of_template.json&quot;,
            output_path=&quot;/path/to/write/rendered_output_to.json&quot;,
        ),
        description=&quot;Template rendering configuration&quot;,
    )
</code></pre>
<p>LUTE looks for the template in <code>config/templates</code>, so only the name of the template file to use within that directory is required for the <code>template_name</code> attribute of <code>lute_template_cfg</code>. LUTE can write the output anywhere (the user has permissions), and with any name, so the full absolute path including filename should be used for the <code>output_path</code> of <code>lute_template_cfg</code>.</p>
<p>The rest of the work is done by the combination of Jinja, LUTE's configuration YAML file, and the template itself. Understanding the interplay between these components is perhaps best illustrated by an example. As such, let us consider a simple third-party <code>Task</code> whose only input parameter (on the command-line) is the location of a configuration JSON file. We'll call the third-party executable <code>jsonuser</code> and our <code>Task</code> model, the <code>RunJsonUserParameters</code>. We assume the program is run like:</p>
<pre><code class="language-bash">jsonuser -i &lt;input_file.json&gt;
</code></pre>
<p>The first step is to setup the pydantic model as before.</p>
<pre><code class="language-py">from pydantic import Field, validator

from .base import TemplateConfig

class RunJsonUserParameters:
    executable: str = Field(
        &quot;/path/to/jsonuser&quot;, description=&quot;Executable which requires a JSON configuration file.&quot;
    )
    # Lets assume the JSON file is passed as &quot;-i &lt;path_to_json&gt;&quot;
    input_json: str = Field(
        &quot;&quot;, description=&quot;Path to the input JSON file.&quot;, flag_type=&quot;-&quot;, rename_param=&quot;i&quot;
    )
</code></pre>
<p>The next step is to create a template for the JSON file. Let's assume the JSON file looks like:</p>
<pre><code>{
    &quot;param1&quot;: &quot;arg1&quot;,
    &quot;param2&quot;: 4,
    &quot;param3&quot;: {
        &quot;a&quot;: 1,
        &quot;b&quot;: 2
    },
    &quot;param4&quot;: [
        1,
        2,
        3
    ]
}
</code></pre>
<p>Any, or all of these values can be substituted for, and we can determine the way in which we will provide them. I.e. a substitution can be provided for each variable individually, or, for example for a nested hierarchy, a dictionary can be provided which will substitute all the items at once. For this simple case, let's provide variables for <code>param1</code>, <code>param2</code>, <code>param3.b</code> and assume that we want the first and second entries for <code>param4</code> to be identical for our use case (i.e., we can use one variable for them both. In total, this means we will perform 5 substitutions using 4 variables. Jinja will substitute a variable anywhere it sees the following syntax, <code>{{ variable_name }}</code>. As such a valid template for our use-case may look like:</p>
<pre><code>{
    &quot;param1&quot;: {{ str_var }},
    &quot;param2&quot;: {{ int_var }},
    &quot;param3&quot;: {
        &quot;a&quot;: 1,
        &quot;b&quot;: {{ p3_b }}
    },
    &quot;param4&quot;: [
        {{ val }},
        {{ val }},
        3
    ]
}
</code></pre>
<p>We save this file as <code>jsonuser.json</code> in <code>config/templates</code>. Next, we will update the original pydantic model to include our template configuration. We still have an issue, however, in that we need to decide where to write the output of the template to. In this case, we can use the <code>input_json</code> parameter. We will assume that the user will provide this, although a default value can also be used. A custom validator will be added so that we can take the <code>input_json</code> value and update the value of <code>lute_template_cfg.output_path</code> with it.</p>
<pre><code class="language-py"># from typing import Optional

from pydantic import Field, validator

from .base import TemplateConfig #, TemplateParameters

class RunJsonUserParameters:
    executable: str = Field(
        &quot;jsonuser&quot;, description=&quot;Executable which requires a JSON configuration file.&quot;
    )
    # Lets assume the JSON file is passed as &quot;-i &lt;path_to_json&gt;&quot;
    input_json: str = Field(
        &quot;&quot;, description=&quot;Path to the input JSON file.&quot;, flag_type=&quot;-&quot;, rename_param=&quot;i&quot;
    )
    # Add template configuration! *MUST* be called `lute_template_cfg`
    lute_template_cfg: TemplateConfig = Field(
        TemplateConfig(
            template_name=&quot;jsonuser.json&quot;, # Only the name of the file here.
            output_path=&quot;&quot;,
        ),
        description=&quot;Template rendering configuration&quot;,
    )
    # We do not need to include these TemplateParameters, they will be added
    # automatically if provided in the YAML
    #str_var: Optional[TemplateParameters]
    #int_var: Optional[TemplateParameters]
    #p3_b: Optional[TemplateParameters]
    #val: Optional[TemplateParameters]


    # Tell LUTE to write the rendered template to the location provided with
    # `input_json`. I.e. update `lute_template_cfg.output_path`
    @validator(&quot;lute_template_cfg&quot;, always=True)
    def update_output_path(
        cls, lute_template_cfg: TemplateConfig, values: Dict[str, Any]
    ) -&gt; TemplateConfig:
        if lute_template_cfg.output_path == &quot;&quot;:
            lute_template_cfg.output_path = values[&quot;input_json&quot;]
        return lute_template_cfg
</code></pre>
<p>All that is left to render the template, is to provide the variables we want to substitute in the LUTE configuration YAML. In our case we must provide the 4 variable names we included within the substitution syntax (<code>{{ var_name }}</code>). The names in the YAML must match those in the template.</p>
<pre><code class="language-yaml">RunJsonUser:
    input_json: &quot;/my/chosen/path.json&quot; # We'll come back to this...
    str_var: &quot;arg1&quot; # Will substitute for &quot;param1&quot;: &quot;arg1&quot;
    int_var: 4 # Will substitute for &quot;param2&quot;: 4
    p3_b: 2  # Will substitute for &quot;param3: { &quot;b&quot;: 2 }
    val: 2 # Will substitute for &quot;param4&quot;: [2, 2, 3] in the JSON
</code></pre>
<p>If on the other hand, a user were to have an already valid JSON file, it is possible to turn off the template rendering. (ALL) Template variables (<code>TemplateParameters</code>) are simply excluded from the configuration YAML.</p>
<pre><code class="language-yaml">RunJsonUser:
    input_json: &quot;/path/to/existing.json&quot;
    #str_var: ...
    #...
</code></pre>
<h4 id="validated-template-parameters">Validated template parameters</h4>
<p>If you are able to provide validation for template parameters this is preferred, although it is not always straightforward to determine appropriate parameter types/validators. LUTE provides a custom validator which can be used in conjunction with a separate pydantic model for the template parameters to provide type-checking.</p>
<p>By way of example, we will re-write the model above for the <code>RunJsonUser</code> <code>Task</code> in order to validate the template parameters. We begin by creating a new pydantic <code>BaseModel</code> to hold all the template parameters. This class can be defined anywhere, but for organizational purposes the class is often defined within the <code>TaskParameters</code> class.</p>
<pre><code class="language-py"># Import BaseModel if not present - required for validation!
from pydantic import BaseModel

class RunJsonUserParameters:

    class RunJsonTemplateParameters(BaseModel):
        # If you want to allow extra, un-validated parameters include this
        # Config as well.
        # class Config(BaseModel.Config):
        #     extra: str = &quot;allow&quot;

        str_var: Optional[str] = Field(
            None, description=&quot;This string does...&quot;
        )
        int_var: Optional[int] = Field(
            None, description=&quot;This int does...&quot;
        )
        p3_b: Optional[int] = Field(
            None, description=&quot;This parameter does...&quot;
        )
        val: Optional[int] = Field(
            None, description=&quot;This parameter does...&quot;
        )
</code></pre>
<p>Next the template parameters defined in the class need to be made available through a validated parameter within the <code>TaskParameters</code> class. We will import a special validator defined in <code>lute.io.models.validators</code> in order to perform the necessary options to handle the individual template parameters during validation.</p>
<pre><code class="language-py"># Import BaseModel if not present - required for validation!
from pydantic import BaseModel

# Import custom validators for template parameters!
from lute.io.models.validators import template_parameter_validator

class RunJsonUserParameters:

    class RunJsonTemplateParameters:
        # If you want to allow extra, un-validated parameters include this
        # Config as well.
        # class Config(BaseModel.Config):
        #     extra: str = &quot;allow&quot;

        str_var: Optional[str] = Field(
            None, description=&quot;This string does...&quot;
        )
        int_var: Optional[int] = Field(
            None, description=&quot;This int does...&quot;
        )
        p3_b: Optional[int] = Field(
            None, description=&quot;This parameter does...&quot;
        )
        val: Optional[int] = Field(
            None, description=&quot;This parameter does...&quot;
        )
    # Define the validator - the argument must match the parameter name!
    _set_template_parameters = template_parameter_validator(&quot;json_parameters&quot;)

    # executable...
    # input_json...
    json_parameters: Optional[RunJsonTemplateParameters] = Field(
        None, description=&quot;Optional template parameters...&quot;
    )
</code></pre>
<p>The rest of the model remains unchanged. However, we <strong>do</strong> need to make a change to how we pass the template parameters to LUTE through the configuration YAML. Previously, we provided each template parameter (<code>str_var</code>, <code>int_var</code>, ...) as an individual parameter in the YAML file. Now, they must be passed as a dictionary under the key <code>json_parameters</code>, as this is the parameter we have defined to hold template parameters in the model.</p>
<pre><code class="language-yaml">RunJsonUser:
    input_json: &quot;/my/chosen/path.json&quot; # We'll come back to this...
    json_parameters:
        str_var: &quot;arg1&quot; # Will substitute for &quot;param1&quot;: &quot;arg1&quot;
        int_var: 4 # Will substitute for &quot;param2&quot;: 4
        p3_b: 2  # Will substitute for &quot;param3: { &quot;b&quot;: 2 }
        val: 2 # Will substitute for &quot;param4&quot;: [2, 2, 3] in the JSON
</code></pre>
<p>Now, the individual parameters will be validated according to the model definition (<code>RunJsonTemplateParameters</code>). As previously, if we do not want to use any template parameters, we simply remove them from the YAML, although in this case, we must remove the full section beginning with <code>json_parameters</code>. As we've used the same parameter names as previously, our Jinja template does not need to change</p>
<h4 id="additional-jinja-syntax">Additional Jinja Syntax</h4>
<p>There are many other syntactical constructions we can use with Jinja. Some of the useful ones are:</p>
<p><strong>If Statements</strong> - E.g. only include portions of the template if a value is defined.</p>
<pre><code>{% if VARNAME is defined %}
// Stuff to include
{% endif %}
</code></pre>
<p><strong>Loops</strong> - E.g. Unpacking multiple elements from a dictionary.</p>
<pre><code>{% for name, value in VARNAME.items() %}
// Do stuff with name and value
{% endfor %}
</code></pre>
<h2 id="creating-a-first-party-task">Creating a "First-Party" <code>Task</code></h2>
<p>The process for creating a "First-Party" <code>Task</code> is very similar to that for a "Third-Party" <code>Task</code>, with the difference being that you must also write the analysis code. The steps for integration are:
1. Write the <code>TaskParameters</code> model.
2. Write the <code>Task</code> class. There are a few rules that need to be adhered to.
3. Make your <code>Task</code> available by modifying the import function.
4. Specify an <code>Executor</code></p>
<h3 id="specifying-a-taskparameters-model-for-your-task_1">Specifying a <code>TaskParameters</code> Model for your <code>Task</code></h3>
<p>Parameter models have a format that must be followed for "Third-Party" <code>Task</code>s, but "First-Party" <code>Task</code>s have a little more liberty in how parameters are dealt with, since the <code>Task</code> will do all the parsing itself.</p>
<p>To create a model, the basic steps are:</p>
<ol>
<li>If necessary, create a new module (e.g. <code>new_task_category.py</code>) under <code>lute.io.models</code>, or find an appropriate pre-existing module in that directory.</li>
<li>An <code>import</code> statement must be added to <code>lute.io.models._init_</code> if a new module is created, so it can be found.</li>
<li>If defining the model in a pre-existing module, make sure to modify the <code>__all__</code> statement to include it.</li>
<li>
<p>Create a new model that inherits from <code>TaskParameters</code>. You can look at <code>lute.models.io.tests.TestReadOutputParameters</code> for an example. <strong>The model must be named</strong> <code>&lt;YourTaskName&gt;Parameters</code></p>
</li>
<li>
<p>You should include <strong>all</strong> relevant parameters here, including input file, output file, and any potentially adjustable parameters. These parameters <strong>must</strong> be included even if there are some implicit dependencies between <code>Task</code>s and it would make sense for the parameter to be auto-populated based on some other output. Creating this dependency is done with validators (see step 3.). All parameters should be overridable, and all <code>Task</code>s should be fully-independently configurable, based solely on their model and the configuration YAML.</p>
</li>
<li>To follow the preferred format, parameters should be defined as: <code>param_name: type = Field([default value], description="This parameter does X.")</code></li>
<li>
<p>Use validators to do more complex things for your parameters, including populating default values dynamically:</p>
</li>
<li>
<p>E.g. create default values that depend on other parameters in the model - see for example: <a href="https://github.com/slac-lcls/lute/blob/57f2a0889ec9603e3b8642f485c27df7d1f6e96f/lute/io/models/smd.py#L139">SubmitSMDParameters</a>.</p>
</li>
<li>E.g. create default values that depend on other <code>Task</code>s by reading from the database - see for example: <a href="https://github.com/slac-lcls/lute/blob/57f2a0889ec9603e3b8642f485c27df7d1f6e96f/lute/io/models/tests.py#L75">TestReadOutputParameters</a>.</li>
<li>
<p>The model will have access to some general configuration values by inheriting from <code>TaskParameters</code>. These parameters are all stored in <code>lute_config</code> which is an instance of <code>AnalysisHeader</code> (<a href="https://github.com/slac-lcls/lute/blob/57f2a0889ec9603e3b8642f485c27df7d1f6e96f/lute/io/models/base.py#L42">defined here</a>).</p>
</li>
<li>
<p>For example, the experiment and run number can be obtained from this object and a validator could use these values to define the default input file for the <code>Task</code>.</p>
</li>
</ol>
<p>A number of configuration options and <strong>Field</strong> attributes are also available for "First-Party" <code>Task</code> models. These are identical to those used for the <code>ThirdPartyTask</code>s, although there is a smaller selection. These options are reproduced below for convenience.</p>
<p><strong>Config settings and options</strong>
Under the class definition for <code>Config</code> in the model, we can modify global options for all the parameters. In addition, there are a number of configuration options related to specifying what the outputs/results from the associated <code>Task</code> are, and a number of options to modify runtime behaviour. Currently, the available configuration options are:</p>
<table>
<thead>
<tr>
<th style="text-align: center;"><strong>Config Parameter</strong></th>
<th style="text-align: center;"><strong>Meaning</strong></th>
<th style="text-align: center;"><strong>Default Value</strong></th>
<th style="text-align: center;"><strong>ThirdPartyTask-specific?</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><code>run_directory</code></td>
<td style="text-align: center;">If provided, can be used to specify the directory from which a <code>Task</code> is run.</td>
<td style="text-align: center;"><code>None</code> (not provided)</td>
<td style="text-align: center;"><strong>NO</strong></td>
</tr>
<tr>
<td style="text-align: center;"><code>set_result</code></td>
<td style="text-align: center;"><code>bool</code>. If <code>True</code> search the model definition for a parameter that indicates what the result is.</td>
<td style="text-align: center;"><code>False</code></td>
<td style="text-align: center;"><strong>NO</strong></td>
</tr>
<tr>
<td style="text-align: center;"><code>result_from_params</code></td>
<td style="text-align: center;">If <code>set_result</code> is <code>True</code> can define a result using this option and a validator. See also <code>is_result</code> below.</td>
<td style="text-align: center;"><code>None</code> (not provided)</td>
<td style="text-align: center;"><strong>NO</strong></td>
</tr>
<tr>
<td style="text-align: center;"><code>short_flags_use_eq</code></td>
<td style="text-align: center;">Use equals sign instead of space for arguments of <code>-</code> parameters.</td>
<td style="text-align: center;"><code>False</code></td>
<td style="text-align: center;"><strong>YES</strong> - Only affects <code>ThirdPartyTask</code>s</td>
</tr>
<tr>
<td style="text-align: center;"><code>long_flags_use_eq</code></td>
<td style="text-align: center;">Use equals sign instead of space for arguments of <code>-</code> parameters.</td>
<td style="text-align: center;"><code>False</code></td>
<td style="text-align: center;"><strong>YES</strong> - Only affects <code>ThirdPartyTask</code>s</td>
</tr>
<tr>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
</tr>
</tbody>
</table>
<p>These configuration options modify how the parameter models are parsed and passed along on the command-line, as well as what we consider results and where a <code>Task</code> can run. The default behaviour is that parameters are assumed to be passed as <code>-p arg</code> and <code>--param arg</code>, the <code>Task</code> will be run in the current working directory (or scratch if submitted with the ARP), and we have no information about <code>Task</code> results . Setting the above options can modify this behaviour.</p>
<ul>
<li>By setting <code>short_flags_use_eq</code> and/or <code>long_flags_use_eq</code> to <code>True</code> parameters are instead passed as <code>-p=arg</code> and <code>--param=arg</code>.</li>
<li>By setting <code>run_directory</code> to a valid path, we can force a <code>Task</code> to be run in a specific directory. By default the <code>Task</code> will be run from the directory you submit the job in, or from your scratch folder (<code>/sdf/scratch/...</code>) if you submit from the eLog. Some <code>ThirdPartyTask</code>s rely on searching the correct working directory in order run properly.</li>
<li>By setting <code>set_result</code> to <code>True</code> we indicate that the <code>TaskParameters</code> model will provide information on what the <code>TaskResult</code> is. This setting must be used with one of two options, either the <code>result_from_params</code> <code>Config</code> option, described below, or the <strong>Field</strong> attribute <code>is_result</code> described in the next sub-section (<strong>Field Attributes</strong>).</li>
<li><code>result_from_params</code> is a Config option that can be used when <code>set_result==True</code>. In conjunction with a <strong>validator</strong> (described a sections down) we can use this option to specify a result from all the information contained in the model. E.g. if you have a <code>Task</code> that has parameters for an <code>output_directory</code> and a <code>output_filename</code>, you can set <code>result_from_params==f"{output_directory}/{output_filename}"</code>.</li>
</ul>
<p><strong>Field attributes</strong>
In addition to the global configuration options there are a couple of ways to specify individual parameters. The following <code>Field</code> attributes are used when parsing the model:</p>
<table>
<thead>
<tr>
<th style="text-align: center;"><strong>Field Attribute</strong></th>
<th style="text-align: center;"><strong>Meaning</strong></th>
<th style="text-align: center;"><strong>Default Value</strong></th>
<th style="text-align: center;"><strong>Example</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><code>description</code></td>
<td style="text-align: center;">Documentation of the parameter's usage or purpose.</td>
<td style="text-align: center;">N/A</td>
<td style="text-align: center;"><code>arg = Field(..., description="Argument for...")</code></td>
</tr>
<tr>
<td style="text-align: center;"><code>is_result</code></td>
<td style="text-align: center;"><code>bool</code>. If the <code>set_result</code> <code>Config</code> option is <code>True</code>, we can set this to <code>True</code> to indicate a result.</td>
<td style="text-align: center;">N/A</td>
<td style="text-align: center;"><code>output_result = Field(..., is_result=true)</code></td>
</tr>
<tr>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
</tr>
</tbody>
</table>
<h3 id="writing-the-task">Writing the <code>Task</code></h3>
<p>You can write your analysis code (or whatever code to be executed) as long as it adheres to the limited rules below. You can create a new module for your <code>Task</code> in <code>lute.tasks</code> or add it to any existing module, if it makes sense for it to belong there. The <code>Task</code> itself is a single class constructed as:</p>
<ol>
<li>Your analysis <code>Task</code> is a class named in a way that matches its Pydantic model. E.g. <code>RunTask</code> is the <code>Task</code>, and <code>RunTaskParameters</code> is the Pydantic model.</li>
<li>The class must inherit from the <code>Task</code> class (see template below). <strong>If you intend to use MPI see the following section.</strong></li>
<li>You must provide an implementation of a <code>_run</code> method. This is the method that will be executed when the <code>Task</code> is run. You can in addition write as many methods as you need. For fine-grained execution control you can also provide <code>_pre_run()</code> and <code>_post_run()</code> methods, but this is optional.</li>
<li>For all communication (including print statements) you should use the <code>_report_to_executor(msg: Message)</code> method. Since the <code>Task</code> is run as a subprocess this method will pass information to the controlling <code>Executor</code>. You can pass <strong>any</strong> type of object using this method, strings, plots, arrays, etc.</li>
<li>If you did not use the <code>set_result</code> configuration option in your parameters model, make sure to provide a result when finished. This is done by setting <code>self._result.payload = ...</code>. You can set the result to be any object. If you have written the result to a file, for example, please provide a path.</li>
</ol>
<p>A minimal template is provided below.</p>
<pre><code class="language-py">&quot;&quot;&quot;Standard docstring...&quot;&quot;&quot;

__all__ = [&quot;RunTask&quot;]
__author__ = &quot;&quot; # Please include so we know who the SME is

# Include any imports you need here

from lute.execution.ipc import Message # Message for communication
from lute.io.models.base import *      # For TaskParameters
from lute.tasks.task import *          # For Task

class RunTask(Task): # Inherit from Task
    &quot;&quot;&quot;Task description goes here, or in __init__&quot;&quot;&quot;

    def __init__(self, *, params: TaskParameters) -&gt; None:
        super().__init__(params=params) # Sets up Task, parameters, etc.
        # Parameters will be available through:
          # self._task_parameters
          # You access with . operator: self._task_parameters.param1, etc.
        # Your result object is availble through:
          # self._result
            # self._result.payload &lt;- Main result
            # self._result.summary &lt;- Short summary
            # self._result.task_status &lt;- Semi-automatic, but can be set manually

    def _run(self) -&gt; None:
        # THIS METHOD MUST BE PROVIDED
        self.do_my_analysis()

    def do_my_analysis(self) -&gt; None:
        # Send a message, proper way to print:
        msg: Message(contents=&quot;My message contents&quot;, signal=&quot;&quot;)
        self._report_to_executor(msg)

        # When done, set result - assume we wrote a file, e.g.
        self._result.payload = &quot;/path/to/output_file.h5&quot;
        # Optionally also set status - good practice but not obligatory
        self._result.task_status = TaskStatus.COMPLETED
</code></pre>
<h4 id="using-mpi-for-your-task">Using MPI for your <code>Task</code></h4>
<p>In the case your <code>Task</code> is written to use <code>MPI</code> a slight modification to the template above is needed. Specifically, an additional keyword argument should be passed to the base class initializer: <code>use_mpi=True</code>. This tells the base class to adjust signalling/communication behaviour appropriately for a multi-rank MPI program. Doing this prevents tricky-to-track-down problems due to ranks starting, completing and sending messages at different times. The rest of your code can, as before, be written as you see fit. The use of this keyword argument will also synchronize the start of all ranks and wait until all ranks have finished to exit.</p>
<pre><code class="language-py">&quot;&quot;&quot;Task which needs to run with MPI&quot;&quot;&quot;

__all__ = [&quot;RunTask&quot;]
__author__ = &quot;&quot; # Please include so we know who the SME is

# Include any imports you need here

from lute.execution.ipc import Message # Message for communication
from lute.io.models.base import *      # For TaskParameters
from lute.tasks.task import *          # For Task

# Only the init is shown
class RunMPITask(Task): # Inherit from Task
    &quot;&quot;&quot;Task description goes here, or in __init__&quot;&quot;&quot;

    # Signal the use of MPI!
    def __init__(self, *, params: TaskParameters, use_mpi: bool = True) -&gt; None:
        super().__init__(params=params, use_mpi=use_mpi) # Sets up Task, parameters, etc.
        # That's it.
</code></pre>
<h4 id="message-signals">Message signals</h4>
<p>Signals in <code>Message</code> objects are strings and can be one of the following:</p>
<pre><code class="language-py">LUTE_SIGNALS: Set[str] = {
    &quot;NO_PICKLE_MODE&quot;,
    &quot;TASK_STARTED&quot;,
    &quot;TASK_FAILED&quot;,
    &quot;TASK_STOPPED&quot;,
    &quot;TASK_DONE&quot;,
    &quot;TASK_CANCELLED&quot;,
    &quot;TASK_RESULT&quot;,
}
</code></pre>
<p>Each of these signals is associated with a hook on the <code>Executor</code>-side. They are for the most part used by base classes; however, you can choose to make use of them manually as well.</p>
<h3 id="making-your-task-available">Making your <code>Task</code> available</h3>
<p>Once the <code>Task</code> has been written, it needs to be made available for import. Since different <code>Task</code>s can have conflicting dependencies and environments, this is managed through an import function. When the <code>Task</code> is done, or ready for testing, a condition is added to <code>lute.tasks.__init__.import_task</code>. For example, assume the <code>Task</code> is called <code>RunXASAnalysis</code> and it's defined in a module called <code>xas.py</code>, we would add the following lines to the <code>import_task</code> function:</p>
<pre><code class="language-py"># in lute.tasks.__init__

# ...

def import_task(task_name: str) -&gt; Type[Task]:
    # ...
    if task_name == &quot;RunXASAnalysis&quot;:
        from .xas import RunXASAnalysis

        return RunXASAnalysis
</code></pre>
<h3 id="defining-an-executor">Defining an <code>Executor</code></h3>
<p>The process of <code>Executor</code> definition is identical to the process as described for <code>ThirdPartyTask</code>s above. The one exception is if you defined the <code>Task</code> to use MPI as described in the section above (Using MPI for your <code>Task</code>), you will likely consider using the <code>MPIExecutor</code>.</p>
<h4 id="environment-setup">Environment setup</h4>
<p>Currently, first-party <code>Task</code>s are expected to use the same environment as the <code>Executor</code>, so while you can use the environment update methods to insert environment variables, complete replacement of the environment is not supported. If you have a compelling reason to require this feature, contact the maintainers.</p>
<h4 id="tasklet-usage"><code>tasklet</code> usage</h4>
<p>You can also use <code>tasklet</code> functions with first-party <code>Task</code>s if needed. The preferred method, however, would be to incorporate whatever tasklet code is needed directly into your <code>Task</code>.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
       2024 LCLS
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.83f73b43.min.js"></script>
      
    
  </body>
</html>