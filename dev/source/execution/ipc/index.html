
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
        <meta name="author" content="GFD, VM">
      
      
      
        <link rel="prev" href="../executor/">
      
      
        <link rel="next" href="../debug_utils/">
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.39">
    
    
      
        <title>ipc - LUTE</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.8c3ca2c6.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#execution.ipc" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="LUTE" class="md-header__button md-logo" aria-label="LUTE" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            LUTE
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              ipc
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/slac-lcls/lute" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="LUTE" class="md-nav__button md-logo" aria-label="LUTE" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    LUTE
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/slac-lcls/lute" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../quick_start/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Quick Start
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Usage Manual
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Usage Manual
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../usage/configuration/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Task Configuration
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../usage/running_lute/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Running LUTE
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Developer Documentation
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Developer Documentation
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../development/new_task/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Creating a new Task
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../development/creating_workflows/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Creating a new Workflow
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Source Code
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Source Code
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../managed_tasks/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    managed_tasks
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2" checked>
        
          
          <label class="md-nav__link" for="__nav_4_2" id="__nav_4_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    execution
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4_2">
            <span class="md-nav__icon md-icon"></span>
            execution
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../executor/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    executor
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    ipc
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    ipc
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#execution.ipc" class="md-nav__link">
    <span class="md-ellipsis">
      ipc
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#execution.ipc.Communicator" class="md-nav__link">
    <span class="md-ellipsis">
      Communicator
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Communicator">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#execution.ipc.Communicator.has_messages" class="md-nav__link">
    <span class="md-ellipsis">
      has_messages
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution.ipc.Communicator.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution.ipc.Communicator.clear_communicator" class="md-nav__link">
    <span class="md-ellipsis">
      clear_communicator
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution.ipc.Communicator.delayed_setup" class="md-nav__link">
    <span class="md-ellipsis">
      delayed_setup
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution.ipc.Communicator.read" class="md-nav__link">
    <span class="md-ellipsis">
      read
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution.ipc.Communicator.stage_communicator" class="md-nav__link">
    <span class="md-ellipsis">
      stage_communicator
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution.ipc.Communicator.write" class="md-nav__link">
    <span class="md-ellipsis">
      write
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#execution.ipc.Party" class="md-nav__link">
    <span class="md-ellipsis">
      Party
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Party">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#execution.ipc.Party.EXECUTOR" class="md-nav__link">
    <span class="md-ellipsis">
      EXECUTOR
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution.ipc.Party.TASK" class="md-nav__link">
    <span class="md-ellipsis">
      TASK
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#execution.ipc.PipeCommunicator" class="md-nav__link">
    <span class="md-ellipsis">
      PipeCommunicator
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PipeCommunicator">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#execution.ipc.PipeCommunicator.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution.ipc.PipeCommunicator._safe_unpickle_decode" class="md-nav__link">
    <span class="md-ellipsis">
      _safe_unpickle_decode
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution.ipc.PipeCommunicator.read" class="md-nav__link">
    <span class="md-ellipsis">
      read
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution.ipc.PipeCommunicator.write" class="md-nav__link">
    <span class="md-ellipsis">
      write
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#execution.ipc.SocketCommunicator" class="md-nav__link">
    <span class="md-ellipsis">
      SocketCommunicator
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SocketCommunicator">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#execution.ipc.SocketCommunicator.ACCEPT_TIMEOUT" class="md-nav__link">
    <span class="md-ellipsis">
      ACCEPT_TIMEOUT
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution.ipc.SocketCommunicator.MSG_HEAD" class="md-nav__link">
    <span class="md-ellipsis">
      MSG_HEAD
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution.ipc.SocketCommunicator.MSG_SEP" class="md-nav__link">
    <span class="md-ellipsis">
      MSG_SEP
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution.ipc.SocketCommunicator.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution.ipc.SocketCommunicator._clean_up" class="md-nav__link">
    <span class="md-ellipsis">
      _clean_up
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution.ipc.SocketCommunicator._create_socket_raw" class="md-nav__link">
    <span class="md-ellipsis">
      _create_socket_raw
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution.ipc.SocketCommunicator._create_socket_zmq" class="md-nav__link">
    <span class="md-ellipsis">
      _create_socket_zmq
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution.ipc.SocketCommunicator._find_random_port" class="md-nav__link">
    <span class="md-ellipsis">
      _find_random_port
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution.ipc.SocketCommunicator._get_socket_path" class="md-nav__link">
    <span class="md-ellipsis">
      _get_socket_path
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution.ipc.SocketCommunicator._init_tcp_socket_raw" class="md-nav__link">
    <span class="md-ellipsis">
      _init_tcp_socket_raw
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution.ipc.SocketCommunicator._init_tcp_socket_zmq" class="md-nav__link">
    <span class="md-ellipsis">
      _init_tcp_socket_zmq
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution.ipc.SocketCommunicator._init_unix_socket_raw" class="md-nav__link">
    <span class="md-ellipsis">
      _init_unix_socket_raw
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution.ipc.SocketCommunicator._init_unix_socket_zmq" class="md-nav__link">
    <span class="md-ellipsis">
      _init_unix_socket_zmq
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution.ipc.SocketCommunicator._read_socket" class="md-nav__link">
    <span class="md-ellipsis">
      _read_socket
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution.ipc.SocketCommunicator._read_socket_raw" class="md-nav__link">
    <span class="md-ellipsis">
      _read_socket_raw
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution.ipc.SocketCommunicator._read_socket_zmq" class="md-nav__link">
    <span class="md-ellipsis">
      _read_socket_zmq
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution.ipc.SocketCommunicator._setup_unix_ssh_tunnel" class="md-nav__link">
    <span class="md-ellipsis">
      _setup_unix_ssh_tunnel
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution.ipc.SocketCommunicator._unpack_messages" class="md-nav__link">
    <span class="md-ellipsis">
      _unpack_messages
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution.ipc.SocketCommunicator._write_socket" class="md-nav__link">
    <span class="md-ellipsis">
      _write_socket
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution.ipc.SocketCommunicator.delayed_setup" class="md-nav__link">
    <span class="md-ellipsis">
      delayed_setup
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution.ipc.SocketCommunicator.read" class="md-nav__link">
    <span class="md-ellipsis">
      read
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution.ipc.SocketCommunicator.write" class="md-nav__link">
    <span class="md-ellipsis">
      write
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../debug_utils/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    debug_utils
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../logging/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    logging
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_3" >
        
          
          <label class="md-nav__link" for="__nav_4_3" id="__nav_4_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    tasks
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_3">
            <span class="md-nav__icon md-icon"></span>
            tasks
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tasks/task/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    task
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tasks/tasklets/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    tasklets
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tasks/dataclasses/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    dataclasses
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tasks/sfx_find_peaks/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    sfx_find_peaks
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tasks/sfx_index/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    sfx_index
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tasks/smalldata/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    smalldata
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tasks/_smalldata/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    _smalldata
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tasks/math/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    math
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tasks/test/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    test
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tasks/mpi_test/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    mpi_test
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_3_11" >
        
          
          <label class="md-nav__link" for="__nav_4_3_11" id="__nav_4_3_11_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    util
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_3_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_3_11">
            <span class="md-nav__icon md-icon"></span>
            util
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tasks/util/html/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    html
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_4" >
        
          
          <label class="md-nav__link" for="__nav_4_4" id="__nav_4_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    io
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_4">
            <span class="md-nav__icon md-icon"></span>
            io
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_4_1" >
        
          
          <label class="md-nav__link" for="__nav_4_4_1" id="__nav_4_4_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    models
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_4_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_4_1">
            <span class="md-nav__icon md-icon"></span>
            models
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../io/models/base/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    base
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../io/models/sfx_find_peaks/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    sfx_find_peaks
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../io/models/sfx_index/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    sfx_index
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../io/models/sfx_merge/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    sfx_merge
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../io/models/sfx_solve/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    sfx_solve
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../io/models/smd/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    smd
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../io/models/validators/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    validators
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../io/models/tests/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    tests
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../io/models/mpi_tests/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    mpi_tests
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../io/config/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    config
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../io/db/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    db
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../io/_sqlite/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    _sqlite
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../io/elog/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    elog
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../io/exceptions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    exceptions
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Design and Specifications
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Design and Specifications
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../design/database/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Database
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#execution.ipc" class="md-nav__link">
    <span class="md-ellipsis">
      ipc
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#execution.ipc.Communicator" class="md-nav__link">
    <span class="md-ellipsis">
      Communicator
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Communicator">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#execution.ipc.Communicator.has_messages" class="md-nav__link">
    <span class="md-ellipsis">
      has_messages
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution.ipc.Communicator.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution.ipc.Communicator.clear_communicator" class="md-nav__link">
    <span class="md-ellipsis">
      clear_communicator
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution.ipc.Communicator.delayed_setup" class="md-nav__link">
    <span class="md-ellipsis">
      delayed_setup
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution.ipc.Communicator.read" class="md-nav__link">
    <span class="md-ellipsis">
      read
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution.ipc.Communicator.stage_communicator" class="md-nav__link">
    <span class="md-ellipsis">
      stage_communicator
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution.ipc.Communicator.write" class="md-nav__link">
    <span class="md-ellipsis">
      write
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#execution.ipc.Party" class="md-nav__link">
    <span class="md-ellipsis">
      Party
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Party">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#execution.ipc.Party.EXECUTOR" class="md-nav__link">
    <span class="md-ellipsis">
      EXECUTOR
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution.ipc.Party.TASK" class="md-nav__link">
    <span class="md-ellipsis">
      TASK
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#execution.ipc.PipeCommunicator" class="md-nav__link">
    <span class="md-ellipsis">
      PipeCommunicator
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PipeCommunicator">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#execution.ipc.PipeCommunicator.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution.ipc.PipeCommunicator._safe_unpickle_decode" class="md-nav__link">
    <span class="md-ellipsis">
      _safe_unpickle_decode
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution.ipc.PipeCommunicator.read" class="md-nav__link">
    <span class="md-ellipsis">
      read
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution.ipc.PipeCommunicator.write" class="md-nav__link">
    <span class="md-ellipsis">
      write
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#execution.ipc.SocketCommunicator" class="md-nav__link">
    <span class="md-ellipsis">
      SocketCommunicator
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SocketCommunicator">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#execution.ipc.SocketCommunicator.ACCEPT_TIMEOUT" class="md-nav__link">
    <span class="md-ellipsis">
      ACCEPT_TIMEOUT
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution.ipc.SocketCommunicator.MSG_HEAD" class="md-nav__link">
    <span class="md-ellipsis">
      MSG_HEAD
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution.ipc.SocketCommunicator.MSG_SEP" class="md-nav__link">
    <span class="md-ellipsis">
      MSG_SEP
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution.ipc.SocketCommunicator.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution.ipc.SocketCommunicator._clean_up" class="md-nav__link">
    <span class="md-ellipsis">
      _clean_up
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution.ipc.SocketCommunicator._create_socket_raw" class="md-nav__link">
    <span class="md-ellipsis">
      _create_socket_raw
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution.ipc.SocketCommunicator._create_socket_zmq" class="md-nav__link">
    <span class="md-ellipsis">
      _create_socket_zmq
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution.ipc.SocketCommunicator._find_random_port" class="md-nav__link">
    <span class="md-ellipsis">
      _find_random_port
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution.ipc.SocketCommunicator._get_socket_path" class="md-nav__link">
    <span class="md-ellipsis">
      _get_socket_path
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution.ipc.SocketCommunicator._init_tcp_socket_raw" class="md-nav__link">
    <span class="md-ellipsis">
      _init_tcp_socket_raw
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution.ipc.SocketCommunicator._init_tcp_socket_zmq" class="md-nav__link">
    <span class="md-ellipsis">
      _init_tcp_socket_zmq
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution.ipc.SocketCommunicator._init_unix_socket_raw" class="md-nav__link">
    <span class="md-ellipsis">
      _init_unix_socket_raw
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution.ipc.SocketCommunicator._init_unix_socket_zmq" class="md-nav__link">
    <span class="md-ellipsis">
      _init_unix_socket_zmq
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution.ipc.SocketCommunicator._read_socket" class="md-nav__link">
    <span class="md-ellipsis">
      _read_socket
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution.ipc.SocketCommunicator._read_socket_raw" class="md-nav__link">
    <span class="md-ellipsis">
      _read_socket_raw
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution.ipc.SocketCommunicator._read_socket_zmq" class="md-nav__link">
    <span class="md-ellipsis">
      _read_socket_zmq
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution.ipc.SocketCommunicator._setup_unix_ssh_tunnel" class="md-nav__link">
    <span class="md-ellipsis">
      _setup_unix_ssh_tunnel
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution.ipc.SocketCommunicator._unpack_messages" class="md-nav__link">
    <span class="md-ellipsis">
      _unpack_messages
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution.ipc.SocketCommunicator._write_socket" class="md-nav__link">
    <span class="md-ellipsis">
      _write_socket
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution.ipc.SocketCommunicator.delayed_setup" class="md-nav__link">
    <span class="md-ellipsis">
      delayed_setup
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution.ipc.SocketCommunicator.read" class="md-nav__link">
    <span class="md-ellipsis">
      read
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution.ipc.SocketCommunicator.write" class="md-nav__link">
    <span class="md-ellipsis">
      write
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


  <h1>ipc</h1>

<div class="doc doc-object doc-module">



<a id="execution.ipc"></a>
    <div class="doc doc-contents first">

        <p>Classes and utilities for communication between Executors and subprocesses.</p>
<p>Communicators manage message passing and parsing between subprocesses. They
maintain a limited public interface of "read" and "write" operations. Behind
this interface the methods of communication vary from serialization across
pipes to Unix sockets, etc. All communicators pass a single object called a
"Message" which contains an arbitrary "contents" field as well as an optional
"signal" field.</p>


<p><span class="doc-section-title">Classes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="execution.ipc.Party" href="#execution.ipc.Party">Party</a></code></td>
            <td>
              <div class="doc-md-description">
                <p>Enum describing whether Communicator is on Task-side or Executor-side.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="execution.ipc.Message">Message</span></code></td>
            <td>
              <div class="doc-md-description">
                <p>A dataclass used for passing information from Task to Executor.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="execution.ipc.Communicator" href="#execution.ipc.Communicator">Communicator</a></code></td>
            <td>
              <div class="doc-md-description">
                <p>Abstract base class for Communicator types.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="execution.ipc.PipeCommunicator" href="#execution.ipc.PipeCommunicator">PipeCommunicator</a></code></td>
            <td>
              <div class="doc-md-description">
                <p>Manages communication between Task and Executor via pipes
(stderr and stdout).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="execution.ipc.SocketCommunicator" href="#execution.ipc.SocketCommunicator">SocketCommunicator</a></code></td>
            <td>
              <div class="doc-md-description">
                <p>Manages communication using sockets, either raw or using
zmq. Supports both TCP and Unix sockets.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>



  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="execution.ipc.Communicator" class="doc doc-heading">
            <code>Communicator</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="abc.ABC">ABC</span></code></p>


              <details class="quote">
                <summary>Source code in <code>lute/execution/ipc.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">Communicator</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">party</span><span class="p">:</span> <span class="n">Party</span> <span class="o">=</span> <span class="n">Party</span><span class="o">.</span><span class="n">TASK</span><span class="p">,</span> <span class="n">use_pickle</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Abstract Base Class for IPC Communicator objects.</span>

<span class="sd">        Args:</span>
<span class="sd">            party (Party): Which object (side/process) the Communicator is</span>
<span class="sd">                managing IPC for. I.e., is this the &quot;Task&quot; or &quot;Executor&quot; side.</span>
<span class="sd">            use_pickle (bool): Whether to serialize data using pickle prior to</span>
<span class="sd">                sending it.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_party</span> <span class="o">=</span> <span class="n">party</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_use_pickle</span> <span class="o">=</span> <span class="n">use_pickle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">desc</span> <span class="o">=</span> <span class="s2">&quot;Communicator abstract base class.&quot;</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proc</span><span class="p">:</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Message</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Method for reading data through the communication mechanism.&quot;&quot;&quot;</span>
        <span class="o">...</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">Message</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Method for sending data through the communication mechanism.&quot;&quot;&quot;</span>
        <span class="o">...</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">desc</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__str__</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">has_messages</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Whether the Communicator has remaining messages.</span>

<span class="sd">        The precise method for determining whether there are remaining messages</span>
<span class="sd">        will depend on the specific Communicator sub-class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">stage_communicator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Alternative method for staging outside of context manager.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="fm">__enter__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">clear_communicator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Alternative exit method outside of context manager.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="fm">__exit__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">delayed_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Any setup that should be done later than init.&quot;&quot;&quot;</span>
        <span class="o">...</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h3 id="execution.ipc.Communicator.has_messages" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">has_messages</span><span class="p">:</span> <span class="nb">bool</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Whether the Communicator has remaining messages.</p>
<p>The precise method for determining whether there are remaining messages
will depend on the specific Communicator sub-class.</p>
    </div>

</div>



<div class="doc doc-object doc-function">


<h3 id="execution.ipc.Communicator.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">party</span><span class="o">=</span><span class="n">Party</span><span class="o">.</span><span class="n">TASK</span><span class="p">,</span> <span class="n">use_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Abstract Base Class for IPC Communicator objects.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>party</code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="execution.ipc.Party" href="#execution.ipc.Party">Party</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Which object (side/process) the Communicator is
managing IPC for. I.e., is this the "Task" or "Executor" side.</p>
              </div>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="execution.ipc.Party.TASK" href="#execution.ipc.Party.TASK">TASK</a></code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>use_pickle</code></td>
            <td>
                  <code>bool</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to serialize data using pickle prior to
sending it.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>lute/execution/ipc.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">party</span><span class="p">:</span> <span class="n">Party</span> <span class="o">=</span> <span class="n">Party</span><span class="o">.</span><span class="n">TASK</span><span class="p">,</span> <span class="n">use_pickle</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Abstract Base Class for IPC Communicator objects.</span>

<span class="sd">    Args:</span>
<span class="sd">        party (Party): Which object (side/process) the Communicator is</span>
<span class="sd">            managing IPC for. I.e., is this the &quot;Task&quot; or &quot;Executor&quot; side.</span>
<span class="sd">        use_pickle (bool): Whether to serialize data using pickle prior to</span>
<span class="sd">            sending it.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_party</span> <span class="o">=</span> <span class="n">party</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_use_pickle</span> <span class="o">=</span> <span class="n">use_pickle</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">desc</span> <span class="o">=</span> <span class="s2">&quot;Communicator abstract base class.&quot;</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="execution.ipc.Communicator.clear_communicator" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">clear_communicator</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Alternative exit method outside of context manager.</p>

            <details class="quote">
              <summary>Source code in <code>lute/execution/ipc.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">clear_communicator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Alternative exit method outside of context manager.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="fm">__exit__</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="execution.ipc.Communicator.delayed_setup" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">delayed_setup</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Any setup that should be done later than init.</p>

            <details class="quote">
              <summary>Source code in <code>lute/execution/ipc.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">delayed_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Any setup that should be done later than init.&quot;&quot;&quot;</span>
    <span class="o">...</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="execution.ipc.Communicator.read" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">read</span><span class="p">(</span><span class="n">proc</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-abstractmethod"><code>abstractmethod</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Method for reading data through the communication mechanism.</p>

            <details class="quote">
              <summary>Source code in <code>lute/execution/ipc.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@abstractmethod</span>
<span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proc</span><span class="p">:</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Message</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Method for reading data through the communication mechanism.&quot;&quot;&quot;</span>
    <span class="o">...</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="execution.ipc.Communicator.stage_communicator" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">stage_communicator</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Alternative method for staging outside of context manager.</p>

            <details class="quote">
              <summary>Source code in <code>lute/execution/ipc.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">stage_communicator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Alternative method for staging outside of context manager.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="fm">__enter__</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="execution.ipc.Communicator.write" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">write</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-abstractmethod"><code>abstractmethod</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Method for sending data through the communication mechanism.</p>

            <details class="quote">
              <summary>Source code in <code>lute/execution/ipc.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@abstractmethod</span>
<span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">Message</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Method for sending data through the communication mechanism.&quot;&quot;&quot;</span>
    <span class="o">...</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="execution.ipc.Party" class="doc doc-heading">
            <code>Party</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="enum.Enum">Enum</span></code></p>


        <p>Identifier for which party (side/end) is using a communicator.</p>
<p>For some types of communication streams there may be different interfaces
depending on which side of the communicator you are on. This enum is used
by the communicator to determine which interface to use.</p>

              <details class="quote">
                <summary>Source code in <code>lute/execution/ipc.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span>
<span class="normal">96</span>
<span class="normal">97</span>
<span class="normal">98</span>
<span class="normal">99</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">Party</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Identifier for which party (side/end) is using a communicator.</span>

<span class="sd">    For some types of communication streams there may be different interfaces</span>
<span class="sd">    depending on which side of the communicator you are on. This enum is used</span>
<span class="sd">    by the communicator to determine which interface to use.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">TASK</span> <span class="o">=</span> <span class="mi">0</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The Task (client) side.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">EXECUTOR</span> <span class="o">=</span> <span class="mi">1</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The Executor (server) side.</span>
<span class="sd">    &quot;&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h3 id="execution.ipc.Party.EXECUTOR" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">EXECUTOR</span> <span class="o">=</span> <span class="mi">1</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>The Executor (server) side.</p>
    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="execution.ipc.Party.TASK" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">TASK</span> <span class="o">=</span> <span class="mi">0</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>The Task (client) side.</p>
    </div>

</div>





  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="execution.ipc.PipeCommunicator" class="doc doc-heading">
            <code>PipeCommunicator</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="execution.ipc.Communicator" href="#execution.ipc.Communicator">Communicator</a></code></p>


        <p>Provides communication through pipes over stderr/stdout.</p>
<p>The implementation of this communicator has reading and writing ocurring
on stderr and stdout. In general the <code>Task</code> will be writing while the
<code>Executor</code> will be reading. <code>stderr</code> is used for sending signals.</p>

              <details class="quote">
                <summary>Source code in <code>lute/execution/ipc.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">PipeCommunicator</span><span class="p">(</span><span class="n">Communicator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provides communication through pipes over stderr/stdout.</span>

<span class="sd">    The implementation of this communicator has reading and writing ocurring</span>
<span class="sd">    on stderr and stdout. In general the `Task` will be writing while the</span>
<span class="sd">    `Executor` will be reading. `stderr` is used for sending signals.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">party</span><span class="p">:</span> <span class="n">Party</span> <span class="o">=</span> <span class="n">Party</span><span class="o">.</span><span class="n">TASK</span><span class="p">,</span> <span class="n">use_pickle</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;IPC through pipes.</span>

<span class="sd">        Arbitrary objects may be transmitted using pickle to serialize the data.</span>
<span class="sd">        If pickle is not used</span>

<span class="sd">        Args:</span>
<span class="sd">            party (Party): Which object (side/process) the Communicator is</span>
<span class="sd">                managing IPC for. I.e., is this the &quot;Task&quot; or &quot;Executor&quot; side.</span>
<span class="sd">            use_pickle (bool): Whether to serialize data using Pickle prior to</span>
<span class="sd">                sending it. If False, data is assumed to be text whi</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">party</span><span class="o">=</span><span class="n">party</span><span class="p">,</span> <span class="n">use_pickle</span><span class="o">=</span><span class="n">use_pickle</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">desc</span> <span class="o">=</span> <span class="s2">&quot;Communicates through stderr and stdout using pickle.&quot;</span>

    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proc</span><span class="p">:</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Message</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read from stdout and stderr.</span>

<span class="sd">        Args:</span>
<span class="sd">            proc (subprocess.Popen): The process to read from.</span>

<span class="sd">        Returns:</span>
<span class="sd">            msg (Message): The message read, containing contents and signal.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">signal</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
        <span class="n">contents</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
        <span class="n">raw_signal</span><span class="p">:</span> <span class="nb">bytes</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">raw_contents</span><span class="p">:</span> <span class="nb">bytes</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">raw_signal</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="n">raw_signal</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="n">raw_signal</span>
        <span class="k">if</span> <span class="n">raw_contents</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_pickle</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">contents</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">raw_contents</span><span class="p">)</span>
                <span class="k">except</span> <span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">UnpicklingError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="ne">EOFError</span><span class="p">)</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;PipeCommunicator (Executor) - Set _use_pickle=False&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_use_pickle</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">contents</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_safe_unpickle_decode</span><span class="p">(</span><span class="n">raw_contents</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">contents</span> <span class="o">=</span> <span class="n">raw_contents</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">UnicodeDecodeError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;PipeCommunicator (Executor) - Set _use_pickle=True&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_use_pickle</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">contents</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_safe_unpickle_decode</span><span class="p">(</span><span class="n">raw_contents</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">contents</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">signal</span> <span class="ow">and</span> <span class="n">signal</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">LUTE_SIGNALS</span><span class="p">:</span>
            <span class="c1"># Some tasks write on stderr</span>
            <span class="c1"># If the signal channel has &quot;non-signal&quot; info, add it to</span>
            <span class="c1"># contents</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">contents</span><span class="p">:</span>
                <span class="n">contents</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">signal</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">contents</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">contents</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">signal</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">Message</span><span class="p">(</span><span class="n">contents</span><span class="o">=</span><span class="n">contents</span><span class="p">,</span> <span class="n">signal</span><span class="o">=</span><span class="n">signal</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_safe_unpickle_decode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">maybe_mixed</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;This method is used to unpickle and/or decode a bytes object.</span>

<span class="sd">        It attempts to handle cases where contents can be mixed, i.e., part of</span>
<span class="sd">        the message must be decoded and the other part unpickled. It handles</span>
<span class="sd">        only two-way splits. If there are more complex arrangements such as:</span>
<span class="sd">        &lt;pickled&gt;:&lt;unpickled&gt;:&lt;pickled&gt; etc, it will give up.</span>

<span class="sd">        The simpler two way splits are unlikely to occur in normal usage. They</span>
<span class="sd">        may arise when debugging if, e.g., `print` statements are mixed with the</span>
<span class="sd">        usage of the `_report_to_executor` method.</span>

<span class="sd">        Note that this method works because ONLY text data is assumed to be</span>
<span class="sd">        sent via the pipes. The method needs to be revised to handle non-text</span>
<span class="sd">        data if the `Task` is modified to also send that via PipeCommunicator.</span>
<span class="sd">        The use of pickle is supported to provide for this option if it is</span>
<span class="sd">        necessary. It may be deprecated in the future.</span>

<span class="sd">        Be careful when making changes. This method has seemingly redundant</span>
<span class="sd">        checks because unpickling will not throw an error if a full object can</span>
<span class="sd">        be retrieved. That is, the library will ignore extraneous bytes. This</span>
<span class="sd">        method attempts to retrieve that information if the pickled data comes</span>
<span class="sd">        first in the stream.</span>

<span class="sd">        Args:</span>
<span class="sd">            maybe_mixed (bytes): A bytes object which could require unpickling,</span>
<span class="sd">                decoding, or both.</span>

<span class="sd">        Returns:</span>
<span class="sd">            contents (Optional[str]): The unpickled/decoded contents if possible.</span>
<span class="sd">                Otherwise, None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">contents</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">contents</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">maybe_mixed</span><span class="p">)</span>
            <span class="n">repickled</span><span class="p">:</span> <span class="nb">bytes</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">repickled</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">maybe_mixed</span><span class="p">):</span>
                <span class="c1"># Successful unpickling, but pickle stops even if there are more bytes</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">additional_data</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">maybe_mixed</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">repickled</span><span class="p">)</span> <span class="p">:]</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
                    <span class="n">contents</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">contents</span><span class="si">}{</span><span class="n">additional_data</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>
                    <span class="c1"># Can&#39;t decode the bytes left by pickle, so they are lost</span>
                    <span class="n">missing_bytes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">maybe_mixed</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">repickled</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;PipeCommunicator has truncated message. Unable to retrieve </span><span class="si">{</span><span class="n">missing_bytes</span><span class="si">}</span><span class="s2"> bytes.&quot;</span>
                    <span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">UnpicklingError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="ne">EOFError</span><span class="p">)</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="c1"># Pickle may also throw a ValueError, e.g. this bytes: b&quot;Found! \n&quot;</span>
            <span class="c1"># Pickle may also throw an EOFError, eg. this bytes: b&quot;F0\n&quot;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">contents</span> <span class="o">=</span> <span class="n">maybe_mixed</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">UnicodeDecodeError</span> <span class="k">as</span> <span class="n">err2</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">contents</span> <span class="o">=</span> <span class="n">maybe_mixed</span><span class="p">[:</span> <span class="n">err2</span><span class="o">.</span><span class="n">start</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
                    <span class="n">contents</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">contents</span><span class="si">}{</span><span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">maybe_mixed</span><span class="p">[</span><span class="n">err2</span><span class="o">.</span><span class="n">start</span><span class="p">:])</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err3</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;PipeCommunicator unable to decode/parse data! </span><span class="si">{</span><span class="n">err3</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                    <span class="n">contents</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">contents</span>

    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">Message</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Write to stdout and stderr.</span>

<span class="sd">         The signal component is sent to `stderr` while the contents of the</span>
<span class="sd">         Message are sent to `stdout`.</span>

<span class="sd">        Args:</span>
<span class="sd">            msg (Message): The Message to send.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_pickle</span><span class="p">:</span>
            <span class="n">signal</span><span class="p">:</span> <span class="nb">bytes</span>
            <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">signal</span><span class="p">:</span>
                <span class="n">signal</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">signal</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>

            <span class="n">contents</span><span class="p">:</span> <span class="nb">bytes</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">contents</span><span class="p">)</span>

            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">signal</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span>

            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">raw_signal</span><span class="p">:</span> <span class="nb">str</span>
            <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">signal</span><span class="p">:</span>
                <span class="n">raw_signal</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">signal</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">raw_signal</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

            <span class="n">raw_contents</span><span class="p">:</span> <span class="nb">str</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">contents</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">raw_contents</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">contents</span>
            <span class="k">elif</span> <span class="n">msg</span><span class="o">.</span><span class="n">contents</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">raw_contents</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Cannot send msg contents of type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">contents</span><span class="p">)</span><span class="si">}</span><span class="s2"> when not using pickle!&quot;</span>
                <span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">raw_signal</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">raw_contents</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="execution.ipc.PipeCommunicator.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">party</span><span class="o">=</span><span class="n">Party</span><span class="o">.</span><span class="n">TASK</span><span class="p">,</span> <span class="n">use_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>IPC through pipes.</p>
<p>Arbitrary objects may be transmitted using pickle to serialize the data.
If pickle is not used</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>party</code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="execution.ipc.Party" href="#execution.ipc.Party">Party</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Which object (side/process) the Communicator is
managing IPC for. I.e., is this the "Task" or "Executor" side.</p>
              </div>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="execution.ipc.Party.TASK" href="#execution.ipc.Party.TASK">TASK</a></code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>use_pickle</code></td>
            <td>
                  <code>bool</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to serialize data using Pickle prior to
sending it. If False, data is assumed to be text whi</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>lute/execution/ipc.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">party</span><span class="p">:</span> <span class="n">Party</span> <span class="o">=</span> <span class="n">Party</span><span class="o">.</span><span class="n">TASK</span><span class="p">,</span> <span class="n">use_pickle</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;IPC through pipes.</span>

<span class="sd">    Arbitrary objects may be transmitted using pickle to serialize the data.</span>
<span class="sd">    If pickle is not used</span>

<span class="sd">    Args:</span>
<span class="sd">        party (Party): Which object (side/process) the Communicator is</span>
<span class="sd">            managing IPC for. I.e., is this the &quot;Task&quot; or &quot;Executor&quot; side.</span>
<span class="sd">        use_pickle (bool): Whether to serialize data using Pickle prior to</span>
<span class="sd">            sending it. If False, data is assumed to be text whi</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">party</span><span class="o">=</span><span class="n">party</span><span class="p">,</span> <span class="n">use_pickle</span><span class="o">=</span><span class="n">use_pickle</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">desc</span> <span class="o">=</span> <span class="s2">&quot;Communicates through stderr and stdout using pickle.&quot;</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="execution.ipc.PipeCommunicator._safe_unpickle_decode" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">_safe_unpickle_decode</span><span class="p">(</span><span class="n">maybe_mixed</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>This method is used to unpickle and/or decode a bytes object.</p>
<p>It attempts to handle cases where contents can be mixed, i.e., part of
the message must be decoded and the other part unpickled. It handles
only two-way splits. If there are more complex arrangements such as:
<pickled>:<unpickled>:<pickled> etc, it will give up.</p>
<p>The simpler two way splits are unlikely to occur in normal usage. They
may arise when debugging if, e.g., <code>print</code> statements are mixed with the
usage of the <code>_report_to_executor</code> method.</p>
<p>Note that this method works because ONLY text data is assumed to be
sent via the pipes. The method needs to be revised to handle non-text
data if the <code>Task</code> is modified to also send that via PipeCommunicator.
The use of pickle is supported to provide for this option if it is
necessary. It may be deprecated in the future.</p>
<p>Be careful when making changes. This method has seemingly redundant
checks because unpickling will not throw an error if a full object can
be retrieved. That is, the library will ignore extraneous bytes. This
method attempts to retrieve that information if the pickled data comes
first in the stream.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>maybe_mixed</code></td>
            <td>
                  <code>bytes</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A bytes object which could require unpickling,
decoding, or both.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>contents</code></td>            <td>
                  <code><span title="typing.Optional">Optional</span>[str]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The unpickled/decoded contents if possible.
Otherwise, None.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>lute/execution/ipc.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">_safe_unpickle_decode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">maybe_mixed</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This method is used to unpickle and/or decode a bytes object.</span>

<span class="sd">    It attempts to handle cases where contents can be mixed, i.e., part of</span>
<span class="sd">    the message must be decoded and the other part unpickled. It handles</span>
<span class="sd">    only two-way splits. If there are more complex arrangements such as:</span>
<span class="sd">    &lt;pickled&gt;:&lt;unpickled&gt;:&lt;pickled&gt; etc, it will give up.</span>

<span class="sd">    The simpler two way splits are unlikely to occur in normal usage. They</span>
<span class="sd">    may arise when debugging if, e.g., `print` statements are mixed with the</span>
<span class="sd">    usage of the `_report_to_executor` method.</span>

<span class="sd">    Note that this method works because ONLY text data is assumed to be</span>
<span class="sd">    sent via the pipes. The method needs to be revised to handle non-text</span>
<span class="sd">    data if the `Task` is modified to also send that via PipeCommunicator.</span>
<span class="sd">    The use of pickle is supported to provide for this option if it is</span>
<span class="sd">    necessary. It may be deprecated in the future.</span>

<span class="sd">    Be careful when making changes. This method has seemingly redundant</span>
<span class="sd">    checks because unpickling will not throw an error if a full object can</span>
<span class="sd">    be retrieved. That is, the library will ignore extraneous bytes. This</span>
<span class="sd">    method attempts to retrieve that information if the pickled data comes</span>
<span class="sd">    first in the stream.</span>

<span class="sd">    Args:</span>
<span class="sd">        maybe_mixed (bytes): A bytes object which could require unpickling,</span>
<span class="sd">            decoding, or both.</span>

<span class="sd">    Returns:</span>
<span class="sd">        contents (Optional[str]): The unpickled/decoded contents if possible.</span>
<span class="sd">            Otherwise, None.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">contents</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">contents</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">maybe_mixed</span><span class="p">)</span>
        <span class="n">repickled</span><span class="p">:</span> <span class="nb">bytes</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">repickled</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">maybe_mixed</span><span class="p">):</span>
            <span class="c1"># Successful unpickling, but pickle stops even if there are more bytes</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">additional_data</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">maybe_mixed</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">repickled</span><span class="p">)</span> <span class="p">:]</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
                <span class="n">contents</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">contents</span><span class="si">}{</span><span class="n">additional_data</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>
                <span class="c1"># Can&#39;t decode the bytes left by pickle, so they are lost</span>
                <span class="n">missing_bytes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">maybe_mixed</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">repickled</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;PipeCommunicator has truncated message. Unable to retrieve </span><span class="si">{</span><span class="n">missing_bytes</span><span class="si">}</span><span class="s2"> bytes.&quot;</span>
                <span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">UnpicklingError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="ne">EOFError</span><span class="p">)</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="c1"># Pickle may also throw a ValueError, e.g. this bytes: b&quot;Found! \n&quot;</span>
        <span class="c1"># Pickle may also throw an EOFError, eg. this bytes: b&quot;F0\n&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">contents</span> <span class="o">=</span> <span class="n">maybe_mixed</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">UnicodeDecodeError</span> <span class="k">as</span> <span class="n">err2</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">contents</span> <span class="o">=</span> <span class="n">maybe_mixed</span><span class="p">[:</span> <span class="n">err2</span><span class="o">.</span><span class="n">start</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
                <span class="n">contents</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">contents</span><span class="si">}{</span><span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">maybe_mixed</span><span class="p">[</span><span class="n">err2</span><span class="o">.</span><span class="n">start</span><span class="p">:])</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err3</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;PipeCommunicator unable to decode/parse data! </span><span class="si">{</span><span class="n">err3</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="n">contents</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">contents</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="execution.ipc.PipeCommunicator.read" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">read</span><span class="p">(</span><span class="n">proc</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Read from stdout and stderr.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>proc</code></td>
            <td>
                  <code><span title="subprocess.Popen">Popen</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The process to read from.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>msg</code></td>            <td>
                  <code><span title="execution.ipc.Message">Message</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The message read, containing contents and signal.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>lute/execution/ipc.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proc</span><span class="p">:</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Message</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Read from stdout and stderr.</span>

<span class="sd">    Args:</span>
<span class="sd">        proc (subprocess.Popen): The process to read from.</span>

<span class="sd">    Returns:</span>
<span class="sd">        msg (Message): The message read, containing contents and signal.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">signal</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">contents</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">raw_signal</span><span class="p">:</span> <span class="nb">bytes</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">raw_contents</span><span class="p">:</span> <span class="nb">bytes</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">raw_signal</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">signal</span> <span class="o">=</span> <span class="n">raw_signal</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">signal</span> <span class="o">=</span> <span class="n">raw_signal</span>
    <span class="k">if</span> <span class="n">raw_contents</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_pickle</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">contents</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">raw_contents</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">UnpicklingError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="ne">EOFError</span><span class="p">)</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;PipeCommunicator (Executor) - Set _use_pickle=False&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_use_pickle</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">contents</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_safe_unpickle_decode</span><span class="p">(</span><span class="n">raw_contents</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">contents</span> <span class="o">=</span> <span class="n">raw_contents</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">UnicodeDecodeError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;PipeCommunicator (Executor) - Set _use_pickle=True&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_use_pickle</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">contents</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_safe_unpickle_decode</span><span class="p">(</span><span class="n">raw_contents</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">contents</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">signal</span> <span class="ow">and</span> <span class="n">signal</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">LUTE_SIGNALS</span><span class="p">:</span>
        <span class="c1"># Some tasks write on stderr</span>
        <span class="c1"># If the signal channel has &quot;non-signal&quot; info, add it to</span>
        <span class="c1"># contents</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">contents</span><span class="p">:</span>
            <span class="n">contents</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">signal</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">contents</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">contents</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">signal</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="n">signal</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">Message</span><span class="p">(</span><span class="n">contents</span><span class="o">=</span><span class="n">contents</span><span class="p">,</span> <span class="n">signal</span><span class="o">=</span><span class="n">signal</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="execution.ipc.PipeCommunicator.write" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">write</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Write to stdout and stderr.</p>
<p>The signal component is sent to <code>stderr</code> while the contents of the
 Message are sent to <code>stdout</code>.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>msg</code></td>
            <td>
                  <code><span title="execution.ipc.Message">Message</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The Message to send.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>lute/execution/ipc.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">Message</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Write to stdout and stderr.</span>

<span class="sd">     The signal component is sent to `stderr` while the contents of the</span>
<span class="sd">     Message are sent to `stdout`.</span>

<span class="sd">    Args:</span>
<span class="sd">        msg (Message): The Message to send.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_pickle</span><span class="p">:</span>
        <span class="n">signal</span><span class="p">:</span> <span class="nb">bytes</span>
        <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">signal</span><span class="p">:</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>

        <span class="n">contents</span><span class="p">:</span> <span class="nb">bytes</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">contents</span><span class="p">)</span>

        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">signal</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span>

        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">raw_signal</span><span class="p">:</span> <span class="nb">str</span>
        <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">signal</span><span class="p">:</span>
            <span class="n">raw_signal</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">signal</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">raw_signal</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="n">raw_contents</span><span class="p">:</span> <span class="nb">str</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">contents</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">raw_contents</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">contents</span>
        <span class="k">elif</span> <span class="n">msg</span><span class="o">.</span><span class="n">contents</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">raw_contents</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Cannot send msg contents of type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">contents</span><span class="p">)</span><span class="si">}</span><span class="s2"> when not using pickle!&quot;</span>
            <span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">raw_signal</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">raw_contents</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="execution.ipc.SocketCommunicator" class="doc doc-heading">
            <code>SocketCommunicator</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="execution.ipc.Communicator" href="#execution.ipc.Communicator">Communicator</a></code></p>


        <p>Provides communication over Unix or TCP sockets.</p>
<p>Communication is provided either using sockets with the Python socket library
or using ZMQ. The choice of implementation is controlled by the global bool
<code>USE_ZMQ</code>.</p>


<details class="whether-to-use-tcp-or-unix-sockets-is-controlled-by-the-environment" open>
  <summary>Whether to use TCP or Unix sockets is controlled by the environment</summary>
  <p><code>LUTE_USE_TCP=1</code></p>
</details>        <p>If defined, TCP sockets will be used, otherwise Unix sockets will be used.</p>
<p>Regardless of socket type, the environment variable
                  <code>LUTE_EXECUTOR_HOST=&lt;hostname&gt;</code>
will be defined by the Executor-side Communicator.</p>
<p>For TCP sockets:
The Executor-side Communicator should be run first and will bind to all
interfaces on the port determined by the environment variable:
                        <code>LUTE_PORT=###</code>
If no port is defined, a port scan will be performed and the Executor-side
Communicator will bind the first one available from a random selection. It
will then define the environment variable so the Task-side can pick it up.</p>
<p>For Unix sockets:
The path to the Unix socket is defined by the environment variable:
                  <code>LUTE_SOCKET=/path/to/socket</code>
This class assumes proper permissions and that this above environment
variable has been defined. The <code>Task</code> is configured as what would commonly
be referred to as the <code>client</code>, while the <code>Executor</code> is configured as the
server.</p>
<p>If the Task process is run on a different machine than the Executor, the
Task-side Communicator will open a ssh-tunnel to forward traffic from a local
Unix socket to the Executor Unix socket. Opening of the tunnel relies on the
environment variable:
                  <code>LUTE_EXECUTOR_HOST=&lt;hostname&gt;</code>
to determine the Executor's host. This variable should be defined by the
Executor and passed to the Task process automatically, but it can also be
defined manually if launching the Task process separately. The Task will use
the local socket <code>&lt;LUTE_SOCKET&gt;.task{##}</code>. Multiple local sockets may be
created. Currently, it is assumed that the user is identical on both the Task
machine and Executor machine.</p>

              <details class="quote">
                <summary>Source code in <code>lute/execution/ipc.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span>
<span class="normal">863</span>
<span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span>
<span class="normal">872</span>
<span class="normal">873</span>
<span class="normal">874</span>
<span class="normal">875</span>
<span class="normal">876</span>
<span class="normal">877</span>
<span class="normal">878</span>
<span class="normal">879</span>
<span class="normal">880</span>
<span class="normal">881</span>
<span class="normal">882</span>
<span class="normal">883</span>
<span class="normal">884</span>
<span class="normal">885</span>
<span class="normal">886</span>
<span class="normal">887</span>
<span class="normal">888</span>
<span class="normal">889</span>
<span class="normal">890</span>
<span class="normal">891</span>
<span class="normal">892</span>
<span class="normal">893</span>
<span class="normal">894</span>
<span class="normal">895</span>
<span class="normal">896</span>
<span class="normal">897</span>
<span class="normal">898</span>
<span class="normal">899</span>
<span class="normal">900</span>
<span class="normal">901</span>
<span class="normal">902</span>
<span class="normal">903</span>
<span class="normal">904</span>
<span class="normal">905</span>
<span class="normal">906</span>
<span class="normal">907</span>
<span class="normal">908</span>
<span class="normal">909</span>
<span class="normal">910</span>
<span class="normal">911</span>
<span class="normal">912</span>
<span class="normal">913</span>
<span class="normal">914</span>
<span class="normal">915</span>
<span class="normal">916</span>
<span class="normal">917</span>
<span class="normal">918</span>
<span class="normal">919</span>
<span class="normal">920</span>
<span class="normal">921</span>
<span class="normal">922</span>
<span class="normal">923</span>
<span class="normal">924</span>
<span class="normal">925</span>
<span class="normal">926</span>
<span class="normal">927</span>
<span class="normal">928</span>
<span class="normal">929</span>
<span class="normal">930</span>
<span class="normal">931</span>
<span class="normal">932</span>
<span class="normal">933</span>
<span class="normal">934</span>
<span class="normal">935</span>
<span class="normal">936</span>
<span class="normal">937</span>
<span class="normal">938</span>
<span class="normal">939</span>
<span class="normal">940</span>
<span class="normal">941</span>
<span class="normal">942</span>
<span class="normal">943</span>
<span class="normal">944</span>
<span class="normal">945</span>
<span class="normal">946</span>
<span class="normal">947</span>
<span class="normal">948</span>
<span class="normal">949</span>
<span class="normal">950</span>
<span class="normal">951</span>
<span class="normal">952</span>
<span class="normal">953</span>
<span class="normal">954</span>
<span class="normal">955</span>
<span class="normal">956</span>
<span class="normal">957</span>
<span class="normal">958</span>
<span class="normal">959</span>
<span class="normal">960</span>
<span class="normal">961</span>
<span class="normal">962</span>
<span class="normal">963</span>
<span class="normal">964</span>
<span class="normal">965</span>
<span class="normal">966</span>
<span class="normal">967</span>
<span class="normal">968</span>
<span class="normal">969</span>
<span class="normal">970</span>
<span class="normal">971</span>
<span class="normal">972</span>
<span class="normal">973</span>
<span class="normal">974</span>
<span class="normal">975</span>
<span class="normal">976</span>
<span class="normal">977</span>
<span class="normal">978</span>
<span class="normal">979</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">SocketCommunicator</span><span class="p">(</span><span class="n">Communicator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provides communication over Unix or TCP sockets.</span>

<span class="sd">    Communication is provided either using sockets with the Python socket library</span>
<span class="sd">    or using ZMQ. The choice of implementation is controlled by the global bool</span>
<span class="sd">    `USE_ZMQ`.</span>

<span class="sd">    Whether to use TCP or Unix sockets is controlled by the environment:</span>
<span class="sd">                           `LUTE_USE_TCP=1`</span>
<span class="sd">    If defined, TCP sockets will be used, otherwise Unix sockets will be used.</span>

<span class="sd">    Regardless of socket type, the environment variable</span>
<span class="sd">                      `LUTE_EXECUTOR_HOST=&lt;hostname&gt;`</span>
<span class="sd">    will be defined by the Executor-side Communicator.</span>


<span class="sd">    For TCP sockets:</span>
<span class="sd">    The Executor-side Communicator should be run first and will bind to all</span>
<span class="sd">    interfaces on the port determined by the environment variable:</span>
<span class="sd">                            `LUTE_PORT=###`</span>
<span class="sd">    If no port is defined, a port scan will be performed and the Executor-side</span>
<span class="sd">    Communicator will bind the first one available from a random selection. It</span>
<span class="sd">    will then define the environment variable so the Task-side can pick it up.</span>

<span class="sd">    For Unix sockets:</span>
<span class="sd">    The path to the Unix socket is defined by the environment variable:</span>
<span class="sd">                      `LUTE_SOCKET=/path/to/socket`</span>
<span class="sd">    This class assumes proper permissions and that this above environment</span>
<span class="sd">    variable has been defined. The `Task` is configured as what would commonly</span>
<span class="sd">    be referred to as the `client`, while the `Executor` is configured as the</span>
<span class="sd">    server.</span>

<span class="sd">    If the Task process is run on a different machine than the Executor, the</span>
<span class="sd">    Task-side Communicator will open a ssh-tunnel to forward traffic from a local</span>
<span class="sd">    Unix socket to the Executor Unix socket. Opening of the tunnel relies on the</span>
<span class="sd">    environment variable:</span>
<span class="sd">                      `LUTE_EXECUTOR_HOST=&lt;hostname&gt;`</span>
<span class="sd">    to determine the Executor&#39;s host. This variable should be defined by the</span>
<span class="sd">    Executor and passed to the Task process automatically, but it can also be</span>
<span class="sd">    defined manually if launching the Task process separately. The Task will use</span>
<span class="sd">    the local socket `&lt;LUTE_SOCKET&gt;.task{##}`. Multiple local sockets may be</span>
<span class="sd">    created. Currently, it is assumed that the user is identical on both the Task</span>
<span class="sd">    machine and Executor machine.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ACCEPT_TIMEOUT</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Maximum time to wait to accept connections. Used by Executor-side.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">MSG_HEAD</span><span class="p">:</span> <span class="nb">bytes</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;MSG&quot;</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Start signal of a message. The end of a message is indicated by MSG_HEAD[::-1].</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">MSG_SEP</span><span class="p">:</span> <span class="nb">bytes</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;;;;&quot;</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Separator for parts of a message. Messages have a start, length, message and end.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">party</span><span class="p">:</span> <span class="n">Party</span> <span class="o">=</span> <span class="n">Party</span><span class="o">.</span><span class="n">TASK</span><span class="p">,</span> <span class="n">use_pickle</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;IPC over a TCP or Unix socket.</span>

<span class="sd">        Unlike with the PipeCommunicator, pickle is always used to send data</span>
<span class="sd">        through the socket.</span>

<span class="sd">        Args:</span>
<span class="sd">            party (Party): Which object (side/process) the Communicator is</span>
<span class="sd">                managing IPC for. I.e., is this the &quot;Task&quot; or &quot;Executor&quot; side.</span>

<span class="sd">            use_pickle (bool): Whether to use pickle. Always True currently,</span>
<span class="sd">                passing False does not change behaviour.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">party</span><span class="o">=</span><span class="n">party</span><span class="p">,</span> <span class="n">use_pickle</span><span class="o">=</span><span class="n">use_pickle</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">delayed_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Delays the creation of socket objects.</span>

<span class="sd">        The Executor initializes the Communicator when it is created. Since</span>
<span class="sd">        all Executors are created and available at once we want to delay</span>
<span class="sd">        acquisition of socket resources until a single Executor is ready</span>
<span class="sd">        to use them.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data_socket</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">,</span> <span class="n">zmq</span><span class="o">.</span><span class="n">sugar</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">Socket</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">USE_ZMQ</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">desc</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Communicates using ZMQ through TCP or Unix sockets.&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="p">:</span> <span class="n">zmq</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">Context</span> <span class="o">=</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Context</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data_socket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_socket_zmq</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">desc</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Communicates through a TCP or Unix socket.&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data_socket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_socket_raw</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data_socket</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="n">SocketCommunicator</span><span class="o">.</span><span class="n">ACCEPT_TIMEOUT</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_party</span> <span class="o">==</span> <span class="n">Party</span><span class="o">.</span><span class="n">EXECUTOR</span><span class="p">:</span>
            <span class="c1"># Executor created first so we can define the hostname env variable</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;LUTE_EXECUTOR_HOST&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()</span>
            <span class="c1"># Setup reader thread</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reader_thread</span><span class="p">:</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span>
                <span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_read_socket</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_msg_queue</span><span class="p">:</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_partial_msg</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bytes</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stop_thread</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reader_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Only used by Party.TASK</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_use_ssh_tunnel</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ssh_proc</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_local_socket_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Read</span>
    <span class="c1">############################################################################</span>

    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proc</span><span class="p">:</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Message</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a message from the queue if available.</span>

<span class="sd">        Socket(s) are continuously monitored, and read from when new data is</span>
<span class="sd">        available.</span>

<span class="sd">        Args:</span>
<span class="sd">            proc (subprocess.Popen): The process to read from. Provided for</span>
<span class="sd">                compatibility with other Communicator subtypes. Is ignored.</span>

<span class="sd">        Returns:</span>
<span class="sd">             msg (Message): The message read, containing contents and signal.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">msg</span><span class="p">:</span> <span class="n">Message</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_msg_queue</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">SocketCommunicator</span><span class="o">.</span><span class="n">ACCEPT_TIMEOUT</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">Message</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">msg</span>

    <span class="k">def</span> <span class="nf">_read_socket</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read data from a socket.</span>

<span class="sd">        Socket(s) are continuously monitored, and read from when new data is</span>
<span class="sd">        available.</span>

<span class="sd">        Calls an underlying method for either raw sockets or ZMQ.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stop_thread</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Stopping socket reader thread.&quot;</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="n">USE_ZMQ</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_read_socket_zmq</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_read_socket_raw</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_read_socket_raw</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read data from a socket.</span>

<span class="sd">        Raw socket implementation for the reader thread.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">connection</span><span class="p">:</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span>
        <span class="n">addr</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">connection</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_socket</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
            <span class="n">full_data</span><span class="p">:</span> <span class="nb">bytes</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">8192</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
                    <span class="n">full_data</span> <span class="o">+=</span> <span class="n">data</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_unpack_messages</span><span class="p">(</span><span class="n">full_data</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">timeout</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_read_socket_zmq</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read data from a socket.</span>

<span class="sd">        ZMQ implementation for the reader thread.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">full_data</span><span class="p">:</span> <span class="nb">bytes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_socket</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_unpack_messages</span><span class="p">(</span><span class="n">full_data</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">zmq</span><span class="o">.</span><span class="n">ZMQError</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_unpack_messages</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Unpacks a byte stream into individual messages.</span>

<span class="sd">        Messages are encoded in the following format:</span>
<span class="sd">                 &lt;HEAD&gt;&lt;SEP&gt;&lt;len(msg)&gt;&lt;SEP&gt;&lt;msg&gt;&lt;SEP&gt;&lt;HEAD[::-1]&gt;</span>
<span class="sd">        The items between &lt;&gt; are replaced as follows:</span>
<span class="sd">            - &lt;HEAD&gt;: A start marker</span>
<span class="sd">            - &lt;SEP&gt;: A separator for components of the message</span>
<span class="sd">            - &lt;len(msg)&gt;: The length of the message payload in bytes.</span>
<span class="sd">            - &lt;msg&gt;: The message payload in bytes</span>
<span class="sd">            - &lt;HEAD[::-1]&gt;: The start marker in reverse to indicate the end.</span>

<span class="sd">        Partial messages (a series of bytes which cannot be converted to a full</span>
<span class="sd">        message) are stored for later. An attempt is made to reconstruct the</span>
<span class="sd">        message with the next call to this method.</span>

<span class="sd">        Args:</span>
<span class="sd">            data (bytes): A raw byte stream containing anywhere from a partial</span>
<span class="sd">                message to multiple full messages.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">msg</span><span class="p">:</span> <span class="n">Message</span>
        <span class="n">working_data</span><span class="p">:</span> <span class="nb">bytes</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_partial_msg</span><span class="p">:</span>
            <span class="c1"># Concatenate the previous partial message to the beginning</span>
            <span class="n">working_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_partial_msg</span> <span class="o">+</span> <span class="n">data</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_partial_msg</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">working_data</span> <span class="o">=</span> <span class="n">data</span>
        <span class="k">while</span> <span class="n">working_data</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Message encoding: &lt;HEAD&gt;&lt;SEP&gt;&lt;len&gt;&lt;SEP&gt;&lt;msg&gt;&lt;SEP&gt;&lt;HEAD[::-1]&gt;</span>
                <span class="n">end</span> <span class="o">=</span> <span class="n">working_data</span><span class="o">.</span><span class="n">find</span><span class="p">(</span>
                    <span class="n">SocketCommunicator</span><span class="o">.</span><span class="n">MSG_SEP</span> <span class="o">+</span> <span class="n">SocketCommunicator</span><span class="o">.</span><span class="n">MSG_HEAD</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">msg_parts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">bytes</span><span class="p">]</span> <span class="o">=</span> <span class="n">working_data</span><span class="p">[:</span><span class="n">end</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span>
                    <span class="n">SocketCommunicator</span><span class="o">.</span><span class="n">MSG_SEP</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg_parts</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_partial_msg</span> <span class="o">=</span> <span class="n">working_data</span>
                    <span class="k">break</span>

                <span class="n">cmd</span><span class="p">:</span> <span class="nb">bytes</span>
                <span class="n">nbytes</span><span class="p">:</span> <span class="nb">bytes</span>
                <span class="n">raw_msg</span><span class="p">:</span> <span class="nb">bytes</span>
                <span class="n">cmd</span><span class="p">,</span> <span class="n">nbytes</span><span class="p">,</span> <span class="n">raw_msg</span> <span class="o">=</span> <span class="n">msg_parts</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">raw_msg</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nbytes</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_partial_msg</span> <span class="o">=</span> <span class="n">working_data</span>
                    <span class="k">break</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">raw_msg</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_msg_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">pickle</span><span class="o">.</span><span class="n">UnpicklingError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_partial_msg</span> <span class="o">=</span> <span class="n">working_data</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="n">end</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">working_data</span><span class="p">):</span>
                <span class="c1"># Add len(SEP+HEAD) since end marks the start of &lt;SEP&gt;&lt;HEAD[::-1]</span>
                <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
                    <span class="n">SocketCommunicator</span><span class="o">.</span><span class="n">MSG_SEP</span> <span class="o">+</span> <span class="n">SocketCommunicator</span><span class="o">.</span><span class="n">MSG_HEAD</span>
                <span class="p">)</span>
                <span class="n">working_data</span> <span class="o">=</span> <span class="n">working_data</span><span class="p">[</span><span class="n">end</span> <span class="o">+</span> <span class="n">offset</span> <span class="p">:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">working_data</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>

    <span class="c1"># Write</span>
    <span class="c1">############################################################################</span>

    <span class="k">def</span> <span class="nf">_write_socket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">Message</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sends data over a socket from the &#39;client&#39; (Task) side.</span>

<span class="sd">        Messages are encoded in the following format:</span>
<span class="sd">                 &lt;HEAD&gt;&lt;SEP&gt;&lt;len(msg)&gt;&lt;SEP&gt;&lt;msg&gt;&lt;SEP&gt;&lt;HEAD[::-1]&gt;</span>
<span class="sd">        The items between &lt;&gt; are replaced as follows:</span>
<span class="sd">            - &lt;HEAD&gt;: A start marker</span>
<span class="sd">            - &lt;SEP&gt;: A separator for components of the message</span>
<span class="sd">            - &lt;len(msg)&gt;: The length of the message payload in bytes.</span>
<span class="sd">            - &lt;msg&gt;: The message payload in bytes</span>
<span class="sd">            - &lt;HEAD[::-1]&gt;: The start marker in reverse to indicate the end.</span>

<span class="sd">        This structure is used for decoding the message on the other end.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">cmd</span><span class="p">:</span> <span class="nb">bytes</span> <span class="o">=</span> <span class="n">SocketCommunicator</span><span class="o">.</span><span class="n">MSG_HEAD</span>
        <span class="n">size</span><span class="p">:</span> <span class="nb">bytes</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">end</span><span class="p">:</span> <span class="nb">bytes</span> <span class="o">=</span> <span class="n">SocketCommunicator</span><span class="o">.</span><span class="n">MSG_HEAD</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">sep</span><span class="p">:</span> <span class="nb">bytes</span> <span class="o">=</span> <span class="n">SocketCommunicator</span><span class="o">.</span><span class="n">MSG_SEP</span>
        <span class="n">packed_msg</span><span class="p">:</span> <span class="nb">bytes</span> <span class="o">=</span> <span class="n">cmd</span> <span class="o">+</span> <span class="n">sep</span> <span class="o">+</span> <span class="n">size</span> <span class="o">+</span> <span class="n">sep</span> <span class="o">+</span> <span class="n">data</span> <span class="o">+</span> <span class="n">sep</span> <span class="o">+</span> <span class="n">end</span>
        <span class="k">if</span> <span class="n">USE_ZMQ</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data_socket</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">packed_msg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data_socket</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">packed_msg</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">Message</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Send a single Message.</span>

<span class="sd">        The entire Message (signal and contents) is serialized and sent through</span>
<span class="sd">        a connection over Unix socket.</span>

<span class="sd">        Args:</span>
<span class="sd">            msg (Message): The Message to send.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write_socket</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># Generic create</span>
    <span class="c1">############################################################################</span>

    <span class="k">def</span> <span class="nf">_create_socket_raw</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create either a Unix or TCP socket.</span>

<span class="sd">        If the environment variable:</span>
<span class="sd">                              `LUTE_USE_TCP=1`</span>
<span class="sd">        is defined, a TCP socket is returned, otherwise a Unix socket.</span>

<span class="sd">        Refer to the individual initialization methods for additional environment</span>
<span class="sd">        variables controlling the behaviour of these two communication types.</span>

<span class="sd">        Returns:</span>
<span class="sd">            data_socket (socket.socket): TCP or Unix socket.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">struct</span>

        <span class="n">use_tcp</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;LUTE_USE_TCP&quot;</span><span class="p">)</span>
        <span class="n">sock</span><span class="p">:</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span>
        <span class="k">if</span> <span class="n">use_tcp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_party</span> <span class="o">==</span> <span class="n">Party</span><span class="o">.</span><span class="n">EXECUTOR</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Will use raw TCP sockets.&quot;</span><span class="p">)</span>
            <span class="n">sock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_tcp_socket_raw</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_party</span> <span class="o">==</span> <span class="n">Party</span><span class="o">.</span><span class="n">EXECUTOR</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Will use raw Unix sockets.&quot;</span><span class="p">)</span>
            <span class="n">sock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_unix_socket_raw</span><span class="p">()</span>
        <span class="n">sock</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span>
            <span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SO_LINGER</span><span class="p">,</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;ii&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10000</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">sock</span>

    <span class="k">def</span> <span class="nf">_create_socket_zmq</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">zmq</span><span class="o">.</span><span class="n">sugar</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">Socket</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create either a Unix or TCP socket.</span>

<span class="sd">        If the environment variable:</span>
<span class="sd">                              `LUTE_USE_TCP=1`</span>
<span class="sd">        is defined, a TCP socket is returned, otherwise a Unix socket.</span>

<span class="sd">        Refer to the individual initialization methods for additional environment</span>
<span class="sd">        variables controlling the behaviour of these two communication types.</span>

<span class="sd">        Returns:</span>
<span class="sd">            data_socket (socket.socket): Unix socket object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">socket_type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="n">zmq</span><span class="o">.</span><span class="n">PULL</span><span class="p">,</span> <span class="n">zmq</span><span class="o">.</span><span class="n">PUSH</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_party</span> <span class="o">==</span> <span class="n">Party</span><span class="o">.</span><span class="n">EXECUTOR</span><span class="p">:</span>
            <span class="n">socket_type</span> <span class="o">=</span> <span class="n">zmq</span><span class="o">.</span><span class="n">PULL</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">socket_type</span> <span class="o">=</span> <span class="n">zmq</span><span class="o">.</span><span class="n">PUSH</span>

        <span class="n">data_socket</span><span class="p">:</span> <span class="n">zmq</span><span class="o">.</span><span class="n">sugar</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">Socket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket_type</span><span class="p">)</span>
        <span class="n">data_socket</span><span class="o">.</span><span class="n">set_hwm</span><span class="p">(</span><span class="mi">160000</span><span class="p">)</span>
        <span class="c1"># Need to multiply by 1000 since ZMQ uses ms</span>
        <span class="n">data_socket</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span>
            <span class="n">zmq</span><span class="o">.</span><span class="n">RCVTIMEO</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">SocketCommunicator</span><span class="o">.</span><span class="n">ACCEPT_TIMEOUT</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># Try TCP first</span>
        <span class="n">use_tcp</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;LUTE_USE_TCP&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">use_tcp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_party</span> <span class="o">==</span> <span class="n">Party</span><span class="o">.</span><span class="n">EXECUTOR</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Will use TCP (ZMQ).&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_init_tcp_socket_zmq</span><span class="p">(</span><span class="n">data_socket</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_party</span> <span class="o">==</span> <span class="n">Party</span><span class="o">.</span><span class="n">EXECUTOR</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Will use Unix sockets (ZMQ).&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_init_unix_socket_zmq</span><span class="p">(</span><span class="n">data_socket</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">data_socket</span>

    <span class="c1"># TCP Init</span>
    <span class="c1">############################################################################</span>

    <span class="k">def</span> <span class="nf">_find_random_port</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">min_port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">41923</span><span class="p">,</span> <span class="n">max_port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">64324</span><span class="p">,</span> <span class="n">max_tries</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Find a random open port to bind to if using TCP.&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">choices</span>

        <span class="n">sock</span><span class="p">:</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span>
        <span class="n">ports</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">choices</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">min_port</span><span class="p">,</span> <span class="n">max_port</span><span class="p">),</span> <span class="n">k</span><span class="o">=</span><span class="n">max_tries</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">port</span> <span class="ow">in</span> <span class="n">ports</span><span class="p">:</span>
            <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">sock</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
                <span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">del</span> <span class="n">sock</span>
                <span class="k">return</span> <span class="n">port</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">continue</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_init_tcp_socket_raw</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize a TCP socket.</span>

<span class="sd">        Executor-side code should always be run first. It checks to see if</span>
<span class="sd">        the environment variable</span>
<span class="sd">                                `LUTE_PORT=###`</span>
<span class="sd">        is defined, if so binds it, otherwise find a free port from a selection</span>
<span class="sd">        of random ports. If a port search is performed, the `LUTE_PORT` variable</span>
<span class="sd">        will be defined so it can be picked up by the the Task-side Communicator.</span>

<span class="sd">        In the event that no port can be bound on the Executor-side, or the port</span>
<span class="sd">        and hostname information is unavailable to the Task-side, the program</span>
<span class="sd">        will exit.</span>

<span class="sd">        Returns:</span>
<span class="sd">            data_socket (socket.socket): TCP socket object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data_socket</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
        <span class="n">port</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;LUTE_PORT&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_party</span> <span class="o">==</span> <span class="n">Party</span><span class="o">.</span><span class="n">EXECUTOR</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">port</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># If port is None find one</span>
                <span class="c1"># Executor code executes first</span>
                <span class="n">port</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_random_port</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">port</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># Failed to find a port to bind</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s2">&quot;Executor failed to bind a port. &quot;</span>
                        <span class="s2">&quot;Try providing a LUTE_PORT directly! Exiting!&quot;</span>
                    <span class="p">)</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="c1"># Provide port env var for Task-side</span>
                <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;LUTE_PORT&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">port</span><span class="p">)</span>
            <span class="n">data_socket</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">port</span><span class="p">)))</span>
            <span class="n">data_socket</span><span class="o">.</span><span class="n">listen</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">hostname</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()</span>
            <span class="n">executor_hostname</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;LUTE_EXECUTOR_HOST&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">executor_hostname</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">port</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Task-side does not have host/port information!&quot;</span>
                    <span class="s2">&quot; Check environment variables! Exiting!&quot;</span>
                <span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">hostname</span> <span class="o">==</span> <span class="n">executor_hostname</span><span class="p">:</span>
                <span class="n">data_socket</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="s2">&quot;localhost&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">port</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data_socket</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">executor_hostname</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">port</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">data_socket</span>

    <span class="k">def</span> <span class="nf">_init_tcp_socket_zmq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_socket</span><span class="p">:</span> <span class="n">zmq</span><span class="o">.</span><span class="n">sugar</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">Socket</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize a TCP socket using ZMQ.</span>

<span class="sd">        Equivalent as the method above but requires passing in a ZMQ socket</span>
<span class="sd">        object instead of returning one.</span>

<span class="sd">        Args:</span>
<span class="sd">            data_socket (zmq.socket.Socket): Socket object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">port</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;LUTE_PORT&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_party</span> <span class="o">==</span> <span class="n">Party</span><span class="o">.</span><span class="n">EXECUTOR</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">port</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">new_port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">data_socket</span><span class="o">.</span><span class="n">bind_to_random_port</span><span class="p">(</span><span class="s2">&quot;tcp://*&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">new_port</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># Failed to find a port to bind</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s2">&quot;Executor failed to bind a port. &quot;</span>
                        <span class="s2">&quot;Try providing a LUTE_PORT directly! Exiting!&quot;</span>
                    <span class="p">)</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">port</span> <span class="o">=</span> <span class="n">new_port</span>
                <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;LUTE_PORT&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">port</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data_socket</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;tcp://*:</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Executor bound port </span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">executor_hostname</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;LUTE_EXECUTOR_HOST&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">executor_hostname</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">port</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Task-side does not have host/port information!&quot;</span>
                    <span class="s2">&quot; Check environment variables! Exiting!&quot;</span>
                <span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">data_socket</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;tcp://</span><span class="si">{</span><span class="n">executor_hostname</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Unix Init</span>
    <span class="c1">############################################################################</span>

    <span class="k">def</span> <span class="nf">_get_socket_path</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the socket path, defining one if it is not available.</span>

<span class="sd">        Returns:</span>
<span class="sd">            socket_path (str): Path to the Unix socket.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">socket_path</span><span class="p">:</span> <span class="nb">str</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">socket_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;LUTE_SOCKET&quot;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">uuid</span>
            <span class="kn">import</span> <span class="nn">tempfile</span>

            <span class="c1"># Define a path, and add to environment</span>
            <span class="c1"># Executor-side always created first, Task will use the same one</span>
            <span class="n">socket_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tempfile</span><span class="o">.</span><span class="n">gettempdir</span><span class="p">()</span><span class="si">}</span><span class="s2">/lute_</span><span class="si">{</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span><span class="si">}</span><span class="s2">.sock&quot;</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;LUTE_SOCKET&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">socket_path</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SocketCommunicator defines socket_path: </span><span class="si">{</span><span class="n">socket_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">USE_ZMQ</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;ipc://</span><span class="si">{</span><span class="n">socket_path</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">socket_path</span>

    <span class="k">def</span> <span class="nf">_init_unix_socket_raw</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a Unix socket object.</span>

<span class="sd">        Executor-side code should always be run first. It checks to see if</span>
<span class="sd">        the environment variable</span>
<span class="sd">                                `LUTE_SOCKET=XYZ`</span>
<span class="sd">        is defined, if so binds it, otherwise it will create a new path and</span>
<span class="sd">        define the environment variable for the Task-side to find.</span>

<span class="sd">        On the Task (client-side), this method will also open a SSH tunnel to</span>
<span class="sd">        forward a local Unix socket to an Executor Unix socket if the Task and</span>
<span class="sd">        Executor processes are on different machines.</span>

<span class="sd">        Returns:</span>
<span class="sd">            data_socket (socket.socket): Unix socket object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">socket_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_socket_path</span><span class="p">()</span>
        <span class="n">data_socket</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_UNIX</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_party</span> <span class="o">==</span> <span class="n">Party</span><span class="o">.</span><span class="n">EXECUTOR</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">socket_path</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">socket_path</span><span class="p">)</span>
            <span class="n">data_socket</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">socket_path</span><span class="p">)</span>
            <span class="n">data_socket</span><span class="o">.</span><span class="n">listen</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_party</span> <span class="o">==</span> <span class="n">Party</span><span class="o">.</span><span class="n">TASK</span><span class="p">:</span>
            <span class="n">hostname</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()</span>
            <span class="n">executor_hostname</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;LUTE_EXECUTOR_HOST&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">executor_hostname</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Hostname for Executor process not found! Exiting!&quot;</span><span class="p">)</span>
                <span class="n">data_socket</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">hostname</span> <span class="o">==</span> <span class="n">executor_hostname</span><span class="p">:</span>
                <span class="n">data_socket</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">socket_path</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_local_socket_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_setup_unix_ssh_tunnel</span><span class="p">(</span>
                    <span class="n">socket_path</span><span class="p">,</span> <span class="n">hostname</span><span class="p">,</span> <span class="n">executor_hostname</span>
                <span class="p">)</span>
                <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># Keep trying reconnect until ssh tunnel works.</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">data_socket</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_local_socket_path</span><span class="p">)</span>
                        <span class="k">break</span>
                    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                        <span class="k">continue</span>

        <span class="k">return</span> <span class="n">data_socket</span>

    <span class="k">def</span> <span class="nf">_init_unix_socket_zmq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_socket</span><span class="p">:</span> <span class="n">zmq</span><span class="o">.</span><span class="n">sugar</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">Socket</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize a Unix socket object, using ZMQ.</span>

<span class="sd">        Equivalent as the method above but requires passing in a ZMQ socket</span>
<span class="sd">        object instead of returning one.</span>

<span class="sd">        Args:</span>
<span class="sd">            data_socket (socket.socket): ZMQ object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">socket_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_socket_path</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_party</span> <span class="o">==</span> <span class="n">Party</span><span class="o">.</span><span class="n">EXECUTOR</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">socket_path</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">socket_path</span><span class="p">)</span>
            <span class="n">data_socket</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">socket_path</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_party</span> <span class="o">==</span> <span class="n">Party</span><span class="o">.</span><span class="n">TASK</span><span class="p">:</span>
            <span class="n">hostname</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()</span>
            <span class="n">executor_hostname</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;LUTE_EXECUTOR_HOST&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">executor_hostname</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Hostname for Executor process not found! Exiting!&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_data_socket</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">hostname</span> <span class="o">==</span> <span class="n">executor_hostname</span><span class="p">:</span>
                <span class="n">data_socket</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">socket_path</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Need to remove ipc:// from socket_path for forwarding</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_local_socket_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_setup_unix_ssh_tunnel</span><span class="p">(</span>
                    <span class="n">socket_path</span><span class="p">[</span><span class="mi">6</span><span class="p">:],</span> <span class="n">hostname</span><span class="p">,</span> <span class="n">executor_hostname</span>
                <span class="p">)</span>
                <span class="c1"># Need to add it back</span>
                <span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;ipc://</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_local_socket_path</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">data_socket</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_setup_unix_ssh_tunnel</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">socket_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">hostname</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">executor_hostname</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Prepares an SSH tunnel for forwarding between Unix sockets on two hosts.</span>

<span class="sd">        An SSH tunnel is opened with `ssh -L &lt;local&gt;:&lt;remote&gt; sleep 2`.</span>
<span class="sd">        This method of communication is slightly slower and incurs additional</span>
<span class="sd">        overhead - it should only be used as a backup. If communication across</span>
<span class="sd">        multiple hosts is required consider using TCP.  The Task will use</span>
<span class="sd">        the local socket `&lt;LUTE_SOCKET&gt;.task{##}`. Multiple local sockets may be</span>
<span class="sd">        created. It is assumed that the user is identical on both the</span>
<span class="sd">        Task machine and Executor machine.</span>

<span class="sd">        Returns:</span>
<span class="sd">            local_socket_path (str): The local Unix socket to connect to.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;uuid&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span>
            <span class="kn">import</span> <span class="nn">uuid</span>
        <span class="n">local_socket_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">socket_path</span><span class="si">}</span><span class="s2">.task</span><span class="si">{</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_use_ssh_tunnel</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">ssh_cmd</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;ssh&quot;</span><span class="p">,</span>
            <span class="s2">&quot;-o&quot;</span><span class="p">,</span>
            <span class="s2">&quot;LogLevel=quiet&quot;</span><span class="p">,</span>
            <span class="s2">&quot;-L&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">local_socket_path</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">socket_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">executor_hostname</span><span class="p">,</span>
            <span class="s2">&quot;sleep&quot;</span><span class="p">,</span>
            <span class="s2">&quot;2&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Opening tunnel from </span><span class="si">{</span><span class="n">hostname</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">executor_hostname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ssh_proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">ssh_cmd</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.4</span><span class="p">)</span>  <span class="c1"># Need to wait... -&gt; Use single Task comm at beginning?</span>
        <span class="k">return</span> <span class="n">local_socket_path</span>

    <span class="c1"># Clean up and properties</span>
    <span class="c1">############################################################################</span>

    <span class="k">def</span> <span class="nf">_clean_up</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Clean up connections.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_party</span> <span class="o">==</span> <span class="n">Party</span><span class="o">.</span><span class="n">EXECUTOR</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stop_thread</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reader_thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Closed reading thread.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_data_socket</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">USE_ZMQ</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">term</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="o">...</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;LUTE_USE_TCP&quot;</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_party</span> <span class="o">==</span> <span class="n">Party</span><span class="o">.</span><span class="n">EXECUTOR</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;LUTE_SOCKET&quot;</span><span class="p">))</span>  <span class="c1"># Should be defined</span>
                <span class="k">return</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_ssh_tunnel</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ssh_proc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_ssh_proc</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">has_messages</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_party</span> <span class="o">==</span> <span class="n">Party</span><span class="o">.</span><span class="n">TASK</span><span class="p">:</span>
            <span class="c1"># Shouldn&#39;t be called on Task-side</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_msg_queue</span><span class="o">.</span><span class="n">qsize</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clean_up</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h3 id="execution.ipc.SocketCommunicator.ACCEPT_TIMEOUT" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">ACCEPT_TIMEOUT</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Maximum time to wait to accept connections. Used by Executor-side.</p>
    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="execution.ipc.SocketCommunicator.MSG_HEAD" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">MSG_HEAD</span><span class="p">:</span> <span class="nb">bytes</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;MSG&#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Start signal of a message. The end of a message is indicated by MSG_HEAD[::-1].</p>
    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="execution.ipc.SocketCommunicator.MSG_SEP" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">MSG_SEP</span><span class="p">:</span> <span class="nb">bytes</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;;;;&#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Separator for parts of a message. Messages have a start, length, message and end.</p>
    </div>

</div>



<div class="doc doc-object doc-function">


<h3 id="execution.ipc.SocketCommunicator.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">party</span><span class="o">=</span><span class="n">Party</span><span class="o">.</span><span class="n">TASK</span><span class="p">,</span> <span class="n">use_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>IPC over a TCP or Unix socket.</p>
<p>Unlike with the PipeCommunicator, pickle is always used to send data
through the socket.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>party</code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="execution.ipc.Party" href="#execution.ipc.Party">Party</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Which object (side/process) the Communicator is
managing IPC for. I.e., is this the "Task" or "Executor" side.</p>
              </div>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="execution.ipc.Party.TASK" href="#execution.ipc.Party.TASK">TASK</a></code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>use_pickle</code></td>
            <td>
                  <code>bool</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to use pickle. Always True currently,
passing False does not change behaviour.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>lute/execution/ipc.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">party</span><span class="p">:</span> <span class="n">Party</span> <span class="o">=</span> <span class="n">Party</span><span class="o">.</span><span class="n">TASK</span><span class="p">,</span> <span class="n">use_pickle</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;IPC over a TCP or Unix socket.</span>

<span class="sd">    Unlike with the PipeCommunicator, pickle is always used to send data</span>
<span class="sd">    through the socket.</span>

<span class="sd">    Args:</span>
<span class="sd">        party (Party): Which object (side/process) the Communicator is</span>
<span class="sd">            managing IPC for. I.e., is this the &quot;Task&quot; or &quot;Executor&quot; side.</span>

<span class="sd">        use_pickle (bool): Whether to use pickle. Always True currently,</span>
<span class="sd">            passing False does not change behaviour.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">party</span><span class="o">=</span><span class="n">party</span><span class="p">,</span> <span class="n">use_pickle</span><span class="o">=</span><span class="n">use_pickle</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="execution.ipc.SocketCommunicator._clean_up" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">_clean_up</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Clean up connections.</p>

            <details class="quote">
              <summary>Source code in <code>lute/execution/ipc.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">945</span>
<span class="normal">946</span>
<span class="normal">947</span>
<span class="normal">948</span>
<span class="normal">949</span>
<span class="normal">950</span>
<span class="normal">951</span>
<span class="normal">952</span>
<span class="normal">953</span>
<span class="normal">954</span>
<span class="normal">955</span>
<span class="normal">956</span>
<span class="normal">957</span>
<span class="normal">958</span>
<span class="normal">959</span>
<span class="normal">960</span>
<span class="normal">961</span>
<span class="normal">962</span>
<span class="normal">963</span>
<span class="normal">964</span>
<span class="normal">965</span>
<span class="normal">966</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">_clean_up</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Clean up connections.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_party</span> <span class="o">==</span> <span class="n">Party</span><span class="o">.</span><span class="n">EXECUTOR</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_thread</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reader_thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Closed reading thread.&quot;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_data_socket</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">USE_ZMQ</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">term</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="o">...</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;LUTE_USE_TCP&quot;</span><span class="p">):</span>
        <span class="k">return</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_party</span> <span class="o">==</span> <span class="n">Party</span><span class="o">.</span><span class="n">EXECUTOR</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;LUTE_SOCKET&quot;</span><span class="p">))</span>  <span class="c1"># Should be defined</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_ssh_tunnel</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ssh_proc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ssh_proc</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="execution.ipc.SocketCommunicator._create_socket_raw" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">_create_socket_raw</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Create either a Unix or TCP socket.</p>


<details class="if-the-environment-variable" open>
  <summary>If the environment variable</summary>
  <p><code>LUTE_USE_TCP=1</code></p>
</details>        <p>is defined, a TCP socket is returned, otherwise a Unix socket.</p>
<p>Refer to the individual initialization methods for additional environment
variables controlling the behaviour of these two communication types.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>data_socket</code></td>            <td>
                  <code><span title="socket.socket">socket</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>TCP or Unix socket.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>lute/execution/ipc.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">_create_socket_raw</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create either a Unix or TCP socket.</span>

<span class="sd">    If the environment variable:</span>
<span class="sd">                          `LUTE_USE_TCP=1`</span>
<span class="sd">    is defined, a TCP socket is returned, otherwise a Unix socket.</span>

<span class="sd">    Refer to the individual initialization methods for additional environment</span>
<span class="sd">    variables controlling the behaviour of these two communication types.</span>

<span class="sd">    Returns:</span>
<span class="sd">        data_socket (socket.socket): TCP or Unix socket.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">struct</span>

    <span class="n">use_tcp</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;LUTE_USE_TCP&quot;</span><span class="p">)</span>
    <span class="n">sock</span><span class="p">:</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span>
    <span class="k">if</span> <span class="n">use_tcp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_party</span> <span class="o">==</span> <span class="n">Party</span><span class="o">.</span><span class="n">EXECUTOR</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Will use raw TCP sockets.&quot;</span><span class="p">)</span>
        <span class="n">sock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_tcp_socket_raw</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_party</span> <span class="o">==</span> <span class="n">Party</span><span class="o">.</span><span class="n">EXECUTOR</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Will use raw Unix sockets.&quot;</span><span class="p">)</span>
        <span class="n">sock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_unix_socket_raw</span><span class="p">()</span>
    <span class="n">sock</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span>
        <span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SO_LINGER</span><span class="p">,</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;ii&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10000</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">sock</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="execution.ipc.SocketCommunicator._create_socket_zmq" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">_create_socket_zmq</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Create either a Unix or TCP socket.</p>


<details class="if-the-environment-variable" open>
  <summary>If the environment variable</summary>
  <p><code>LUTE_USE_TCP=1</code></p>
</details>        <p>is defined, a TCP socket is returned, otherwise a Unix socket.</p>
<p>Refer to the individual initialization methods for additional environment
variables controlling the behaviour of these two communication types.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>data_socket</code></td>            <td>
                  <code><span title="socket.socket">socket</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Unix socket object.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>lute/execution/ipc.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">_create_socket_zmq</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">zmq</span><span class="o">.</span><span class="n">sugar</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">Socket</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create either a Unix or TCP socket.</span>

<span class="sd">    If the environment variable:</span>
<span class="sd">                          `LUTE_USE_TCP=1`</span>
<span class="sd">    is defined, a TCP socket is returned, otherwise a Unix socket.</span>

<span class="sd">    Refer to the individual initialization methods for additional environment</span>
<span class="sd">    variables controlling the behaviour of these two communication types.</span>

<span class="sd">    Returns:</span>
<span class="sd">        data_socket (socket.socket): Unix socket object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">socket_type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="n">zmq</span><span class="o">.</span><span class="n">PULL</span><span class="p">,</span> <span class="n">zmq</span><span class="o">.</span><span class="n">PUSH</span><span class="p">]</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_party</span> <span class="o">==</span> <span class="n">Party</span><span class="o">.</span><span class="n">EXECUTOR</span><span class="p">:</span>
        <span class="n">socket_type</span> <span class="o">=</span> <span class="n">zmq</span><span class="o">.</span><span class="n">PULL</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">socket_type</span> <span class="o">=</span> <span class="n">zmq</span><span class="o">.</span><span class="n">PUSH</span>

    <span class="n">data_socket</span><span class="p">:</span> <span class="n">zmq</span><span class="o">.</span><span class="n">sugar</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">Socket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket_type</span><span class="p">)</span>
    <span class="n">data_socket</span><span class="o">.</span><span class="n">set_hwm</span><span class="p">(</span><span class="mi">160000</span><span class="p">)</span>
    <span class="c1"># Need to multiply by 1000 since ZMQ uses ms</span>
    <span class="n">data_socket</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span>
        <span class="n">zmq</span><span class="o">.</span><span class="n">RCVTIMEO</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">SocketCommunicator</span><span class="o">.</span><span class="n">ACCEPT_TIMEOUT</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="c1"># Try TCP first</span>
    <span class="n">use_tcp</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;LUTE_USE_TCP&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">use_tcp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_party</span> <span class="o">==</span> <span class="n">Party</span><span class="o">.</span><span class="n">EXECUTOR</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Will use TCP (ZMQ).&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_tcp_socket_zmq</span><span class="p">(</span><span class="n">data_socket</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_party</span> <span class="o">==</span> <span class="n">Party</span><span class="o">.</span><span class="n">EXECUTOR</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Will use Unix sockets (ZMQ).&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_unix_socket_zmq</span><span class="p">(</span><span class="n">data_socket</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">data_socket</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="execution.ipc.SocketCommunicator._find_random_port" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">_find_random_port</span><span class="p">(</span><span class="n">min_port</span><span class="o">=</span><span class="mi">41923</span><span class="p">,</span> <span class="n">max_port</span><span class="o">=</span><span class="mi">64324</span><span class="p">,</span> <span class="n">max_tries</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Find a random open port to bind to if using TCP.</p>

            <details class="quote">
              <summary>Source code in <code>lute/execution/ipc.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">_find_random_port</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">min_port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">41923</span><span class="p">,</span> <span class="n">max_port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">64324</span><span class="p">,</span> <span class="n">max_tries</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Find a random open port to bind to if using TCP.&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">choices</span>

    <span class="n">sock</span><span class="p">:</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span>
    <span class="n">ports</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">choices</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">min_port</span><span class="p">,</span> <span class="n">max_port</span><span class="p">),</span> <span class="n">k</span><span class="o">=</span><span class="n">max_tries</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">port</span> <span class="ow">in</span> <span class="n">ports</span><span class="p">:</span>
        <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sock</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
            <span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">del</span> <span class="n">sock</span>
            <span class="k">return</span> <span class="n">port</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">continue</span>
    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="execution.ipc.SocketCommunicator._get_socket_path" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">_get_socket_path</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Return the socket path, defining one if it is not available.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>socket_path</code></td>            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the Unix socket.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>lute/execution/ipc.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">_get_socket_path</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the socket path, defining one if it is not available.</span>

<span class="sd">    Returns:</span>
<span class="sd">        socket_path (str): Path to the Unix socket.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">socket_path</span><span class="p">:</span> <span class="nb">str</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">socket_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;LUTE_SOCKET&quot;</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">uuid</span>
        <span class="kn">import</span> <span class="nn">tempfile</span>

        <span class="c1"># Define a path, and add to environment</span>
        <span class="c1"># Executor-side always created first, Task will use the same one</span>
        <span class="n">socket_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tempfile</span><span class="o">.</span><span class="n">gettempdir</span><span class="p">()</span><span class="si">}</span><span class="s2">/lute_</span><span class="si">{</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span><span class="si">}</span><span class="s2">.sock&quot;</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;LUTE_SOCKET&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">socket_path</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SocketCommunicator defines socket_path: </span><span class="si">{</span><span class="n">socket_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">USE_ZMQ</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;ipc://</span><span class="si">{</span><span class="n">socket_path</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">socket_path</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="execution.ipc.SocketCommunicator._init_tcp_socket_raw" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">_init_tcp_socket_raw</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Initialize a TCP socket.</p>
<p>Executor-side code should always be run first. It checks to see if
the environment variable
                        <code>LUTE_PORT=###</code>
is defined, if so binds it, otherwise find a free port from a selection
of random ports. If a port search is performed, the <code>LUTE_PORT</code> variable
will be defined so it can be picked up by the the Task-side Communicator.</p>
<p>In the event that no port can be bound on the Executor-side, or the port
and hostname information is unavailable to the Task-side, the program
will exit.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>data_socket</code></td>            <td>
                  <code><span title="socket.socket">socket</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>TCP socket object.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>lute/execution/ipc.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">_init_tcp_socket_raw</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize a TCP socket.</span>

<span class="sd">    Executor-side code should always be run first. It checks to see if</span>
<span class="sd">    the environment variable</span>
<span class="sd">                            `LUTE_PORT=###`</span>
<span class="sd">    is defined, if so binds it, otherwise find a free port from a selection</span>
<span class="sd">    of random ports. If a port search is performed, the `LUTE_PORT` variable</span>
<span class="sd">    will be defined so it can be picked up by the the Task-side Communicator.</span>

<span class="sd">    In the event that no port can be bound on the Executor-side, or the port</span>
<span class="sd">    and hostname information is unavailable to the Task-side, the program</span>
<span class="sd">    will exit.</span>

<span class="sd">    Returns:</span>
<span class="sd">        data_socket (socket.socket): TCP socket object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data_socket</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
    <span class="n">port</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;LUTE_PORT&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_party</span> <span class="o">==</span> <span class="n">Party</span><span class="o">.</span><span class="n">EXECUTOR</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">port</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># If port is None find one</span>
            <span class="c1"># Executor code executes first</span>
            <span class="n">port</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_random_port</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">port</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Failed to find a port to bind</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Executor failed to bind a port. &quot;</span>
                    <span class="s2">&quot;Try providing a LUTE_PORT directly! Exiting!&quot;</span>
                <span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1"># Provide port env var for Task-side</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;LUTE_PORT&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">port</span><span class="p">)</span>
        <span class="n">data_socket</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">port</span><span class="p">)))</span>
        <span class="n">data_socket</span><span class="o">.</span><span class="n">listen</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">hostname</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()</span>
        <span class="n">executor_hostname</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;LUTE_EXECUTOR_HOST&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">executor_hostname</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">port</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Task-side does not have host/port information!&quot;</span>
                <span class="s2">&quot; Check environment variables! Exiting!&quot;</span>
            <span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">hostname</span> <span class="o">==</span> <span class="n">executor_hostname</span><span class="p">:</span>
            <span class="n">data_socket</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="s2">&quot;localhost&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">port</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data_socket</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">executor_hostname</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">port</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">data_socket</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="execution.ipc.SocketCommunicator._init_tcp_socket_zmq" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">_init_tcp_socket_zmq</span><span class="p">(</span><span class="n">data_socket</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Initialize a TCP socket using ZMQ.</p>
<p>Equivalent as the method above but requires passing in a ZMQ socket
object instead of returning one.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>data_socket</code></td>
            <td>
                  <code><span title="zmq.socket.Socket">Socket</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Socket object.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>lute/execution/ipc.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">_init_tcp_socket_zmq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_socket</span><span class="p">:</span> <span class="n">zmq</span><span class="o">.</span><span class="n">sugar</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">Socket</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize a TCP socket using ZMQ.</span>

<span class="sd">    Equivalent as the method above but requires passing in a ZMQ socket</span>
<span class="sd">    object instead of returning one.</span>

<span class="sd">    Args:</span>
<span class="sd">        data_socket (zmq.socket.Socket): Socket object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">port</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;LUTE_PORT&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_party</span> <span class="o">==</span> <span class="n">Party</span><span class="o">.</span><span class="n">EXECUTOR</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">port</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">new_port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">data_socket</span><span class="o">.</span><span class="n">bind_to_random_port</span><span class="p">(</span><span class="s2">&quot;tcp://*&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">new_port</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Failed to find a port to bind</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Executor failed to bind a port. &quot;</span>
                    <span class="s2">&quot;Try providing a LUTE_PORT directly! Exiting!&quot;</span>
                <span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">port</span> <span class="o">=</span> <span class="n">new_port</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;LUTE_PORT&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">port</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data_socket</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;tcp://*:</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Executor bound port </span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">executor_hostname</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;LUTE_EXECUTOR_HOST&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">executor_hostname</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">port</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Task-side does not have host/port information!&quot;</span>
                <span class="s2">&quot; Check environment variables! Exiting!&quot;</span>
            <span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">data_socket</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;tcp://</span><span class="si">{</span><span class="n">executor_hostname</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="execution.ipc.SocketCommunicator._init_unix_socket_raw" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">_init_unix_socket_raw</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Returns a Unix socket object.</p>
<p>Executor-side code should always be run first. It checks to see if
the environment variable
                        <code>LUTE_SOCKET=XYZ</code>
is defined, if so binds it, otherwise it will create a new path and
define the environment variable for the Task-side to find.</p>
<p>On the Task (client-side), this method will also open a SSH tunnel to
forward a local Unix socket to an Executor Unix socket if the Task and
Executor processes are on different machines.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>data_socket</code></td>            <td>
                  <code><span title="socket.socket">socket</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Unix socket object.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>lute/execution/ipc.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span>
<span class="normal">863</span>
<span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span>
<span class="normal">872</span>
<span class="normal">873</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">_init_unix_socket_raw</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns a Unix socket object.</span>

<span class="sd">    Executor-side code should always be run first. It checks to see if</span>
<span class="sd">    the environment variable</span>
<span class="sd">                            `LUTE_SOCKET=XYZ`</span>
<span class="sd">    is defined, if so binds it, otherwise it will create a new path and</span>
<span class="sd">    define the environment variable for the Task-side to find.</span>

<span class="sd">    On the Task (client-side), this method will also open a SSH tunnel to</span>
<span class="sd">    forward a local Unix socket to an Executor Unix socket if the Task and</span>
<span class="sd">    Executor processes are on different machines.</span>

<span class="sd">    Returns:</span>
<span class="sd">        data_socket (socket.socket): Unix socket object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">socket_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_socket_path</span><span class="p">()</span>
    <span class="n">data_socket</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_UNIX</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_party</span> <span class="o">==</span> <span class="n">Party</span><span class="o">.</span><span class="n">EXECUTOR</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">socket_path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">socket_path</span><span class="p">)</span>
        <span class="n">data_socket</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">socket_path</span><span class="p">)</span>
        <span class="n">data_socket</span><span class="o">.</span><span class="n">listen</span><span class="p">()</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_party</span> <span class="o">==</span> <span class="n">Party</span><span class="o">.</span><span class="n">TASK</span><span class="p">:</span>
        <span class="n">hostname</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()</span>
        <span class="n">executor_hostname</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;LUTE_EXECUTOR_HOST&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">executor_hostname</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Hostname for Executor process not found! Exiting!&quot;</span><span class="p">)</span>
            <span class="n">data_socket</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">hostname</span> <span class="o">==</span> <span class="n">executor_hostname</span><span class="p">:</span>
            <span class="n">data_socket</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">socket_path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_local_socket_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_setup_unix_ssh_tunnel</span><span class="p">(</span>
                <span class="n">socket_path</span><span class="p">,</span> <span class="n">hostname</span><span class="p">,</span> <span class="n">executor_hostname</span>
            <span class="p">)</span>
            <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># Keep trying reconnect until ssh tunnel works.</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">data_socket</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_local_socket_path</span><span class="p">)</span>
                    <span class="k">break</span>
                <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                    <span class="k">continue</span>

    <span class="k">return</span> <span class="n">data_socket</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="execution.ipc.SocketCommunicator._init_unix_socket_zmq" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">_init_unix_socket_zmq</span><span class="p">(</span><span class="n">data_socket</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Initialize a Unix socket object, using ZMQ.</p>
<p>Equivalent as the method above but requires passing in a ZMQ socket
object instead of returning one.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>data_socket</code></td>
            <td>
                  <code><span title="socket.socket">socket</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>ZMQ object.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>lute/execution/ipc.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">875</span>
<span class="normal">876</span>
<span class="normal">877</span>
<span class="normal">878</span>
<span class="normal">879</span>
<span class="normal">880</span>
<span class="normal">881</span>
<span class="normal">882</span>
<span class="normal">883</span>
<span class="normal">884</span>
<span class="normal">885</span>
<span class="normal">886</span>
<span class="normal">887</span>
<span class="normal">888</span>
<span class="normal">889</span>
<span class="normal">890</span>
<span class="normal">891</span>
<span class="normal">892</span>
<span class="normal">893</span>
<span class="normal">894</span>
<span class="normal">895</span>
<span class="normal">896</span>
<span class="normal">897</span>
<span class="normal">898</span>
<span class="normal">899</span>
<span class="normal">900</span>
<span class="normal">901</span>
<span class="normal">902</span>
<span class="normal">903</span>
<span class="normal">904</span>
<span class="normal">905</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">_init_unix_socket_zmq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_socket</span><span class="p">:</span> <span class="n">zmq</span><span class="o">.</span><span class="n">sugar</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">Socket</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize a Unix socket object, using ZMQ.</span>

<span class="sd">    Equivalent as the method above but requires passing in a ZMQ socket</span>
<span class="sd">    object instead of returning one.</span>

<span class="sd">    Args:</span>
<span class="sd">        data_socket (socket.socket): ZMQ object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">socket_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_socket_path</span><span class="p">()</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_party</span> <span class="o">==</span> <span class="n">Party</span><span class="o">.</span><span class="n">EXECUTOR</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">socket_path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">socket_path</span><span class="p">)</span>
        <span class="n">data_socket</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">socket_path</span><span class="p">)</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_party</span> <span class="o">==</span> <span class="n">Party</span><span class="o">.</span><span class="n">TASK</span><span class="p">:</span>
        <span class="n">hostname</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()</span>
        <span class="n">executor_hostname</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;LUTE_EXECUTOR_HOST&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">executor_hostname</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Hostname for Executor process not found! Exiting!&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data_socket</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">hostname</span> <span class="o">==</span> <span class="n">executor_hostname</span><span class="p">:</span>
            <span class="n">data_socket</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">socket_path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Need to remove ipc:// from socket_path for forwarding</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_local_socket_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_setup_unix_ssh_tunnel</span><span class="p">(</span>
                <span class="n">socket_path</span><span class="p">[</span><span class="mi">6</span><span class="p">:],</span> <span class="n">hostname</span><span class="p">,</span> <span class="n">executor_hostname</span>
            <span class="p">)</span>
            <span class="c1"># Need to add it back</span>
            <span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;ipc://</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_local_socket_path</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">data_socket</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="execution.ipc.SocketCommunicator._read_socket" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">_read_socket</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Read data from a socket.</p>
<p>Socket(s) are continuously monitored, and read from when new data is
available.</p>
<p>Calls an underlying method for either raw sockets or ZMQ.</p>

            <details class="quote">
              <summary>Source code in <code>lute/execution/ipc.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">_read_socket</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Read data from a socket.</span>

<span class="sd">    Socket(s) are continuously monitored, and read from when new data is</span>
<span class="sd">    available.</span>

<span class="sd">    Calls an underlying method for either raw sockets or ZMQ.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stop_thread</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Stopping socket reader thread.&quot;</span><span class="p">)</span>
            <span class="k">break</span>
        <span class="k">if</span> <span class="n">USE_ZMQ</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_read_socket_zmq</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_read_socket_raw</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="execution.ipc.SocketCommunicator._read_socket_raw" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">_read_socket_raw</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Read data from a socket.</p>
<p>Raw socket implementation for the reader thread.</p>

            <details class="quote">
              <summary>Source code in <code>lute/execution/ipc.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">_read_socket_raw</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Read data from a socket.</span>

<span class="sd">    Raw socket implementation for the reader thread.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">connection</span><span class="p">:</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span>
    <span class="n">addr</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">connection</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_socket</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
        <span class="n">full_data</span><span class="p">:</span> <span class="nb">bytes</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">8192</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">full_data</span> <span class="o">+=</span> <span class="n">data</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_unpack_messages</span><span class="p">(</span><span class="n">full_data</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">timeout</span><span class="p">:</span>
        <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="execution.ipc.SocketCommunicator._read_socket_zmq" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">_read_socket_zmq</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Read data from a socket.</p>
<p>ZMQ implementation for the reader thread.</p>

            <details class="quote">
              <summary>Source code in <code>lute/execution/ipc.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">_read_socket_zmq</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Read data from a socket.</span>

<span class="sd">    ZMQ implementation for the reader thread.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">full_data</span><span class="p">:</span> <span class="nb">bytes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_socket</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_unpack_messages</span><span class="p">(</span><span class="n">full_data</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">zmq</span><span class="o">.</span><span class="n">ZMQError</span><span class="p">:</span>
        <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="execution.ipc.SocketCommunicator._setup_unix_ssh_tunnel" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">_setup_unix_ssh_tunnel</span><span class="p">(</span><span class="n">socket_path</span><span class="p">,</span> <span class="n">hostname</span><span class="p">,</span> <span class="n">executor_hostname</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Prepares an SSH tunnel for forwarding between Unix sockets on two hosts.</p>
<p>An SSH tunnel is opened with <code>ssh -L &lt;local&gt;:&lt;remote&gt; sleep 2</code>.
This method of communication is slightly slower and incurs additional
overhead - it should only be used as a backup. If communication across
multiple hosts is required consider using TCP.  The Task will use
the local socket <code>&lt;LUTE_SOCKET&gt;.task{##}</code>. Multiple local sockets may be
created. It is assumed that the user is identical on both the
Task machine and Executor machine.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>local_socket_path</code></td>            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The local Unix socket to connect to.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>lute/execution/ipc.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">907</span>
<span class="normal">908</span>
<span class="normal">909</span>
<span class="normal">910</span>
<span class="normal">911</span>
<span class="normal">912</span>
<span class="normal">913</span>
<span class="normal">914</span>
<span class="normal">915</span>
<span class="normal">916</span>
<span class="normal">917</span>
<span class="normal">918</span>
<span class="normal">919</span>
<span class="normal">920</span>
<span class="normal">921</span>
<span class="normal">922</span>
<span class="normal">923</span>
<span class="normal">924</span>
<span class="normal">925</span>
<span class="normal">926</span>
<span class="normal">927</span>
<span class="normal">928</span>
<span class="normal">929</span>
<span class="normal">930</span>
<span class="normal">931</span>
<span class="normal">932</span>
<span class="normal">933</span>
<span class="normal">934</span>
<span class="normal">935</span>
<span class="normal">936</span>
<span class="normal">937</span>
<span class="normal">938</span>
<span class="normal">939</span>
<span class="normal">940</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">_setup_unix_ssh_tunnel</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">socket_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">hostname</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">executor_hostname</span><span class="p">:</span> <span class="nb">str</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Prepares an SSH tunnel for forwarding between Unix sockets on two hosts.</span>

<span class="sd">    An SSH tunnel is opened with `ssh -L &lt;local&gt;:&lt;remote&gt; sleep 2`.</span>
<span class="sd">    This method of communication is slightly slower and incurs additional</span>
<span class="sd">    overhead - it should only be used as a backup. If communication across</span>
<span class="sd">    multiple hosts is required consider using TCP.  The Task will use</span>
<span class="sd">    the local socket `&lt;LUTE_SOCKET&gt;.task{##}`. Multiple local sockets may be</span>
<span class="sd">    created. It is assumed that the user is identical on both the</span>
<span class="sd">    Task machine and Executor machine.</span>

<span class="sd">    Returns:</span>
<span class="sd">        local_socket_path (str): The local Unix socket to connect to.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;uuid&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span>
        <span class="kn">import</span> <span class="nn">uuid</span>
    <span class="n">local_socket_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">socket_path</span><span class="si">}</span><span class="s2">.task</span><span class="si">{</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_use_ssh_tunnel</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">ssh_cmd</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;ssh&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-o&quot;</span><span class="p">,</span>
        <span class="s2">&quot;LogLevel=quiet&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-L&quot;</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">local_socket_path</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">socket_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">executor_hostname</span><span class="p">,</span>
        <span class="s2">&quot;sleep&quot;</span><span class="p">,</span>
        <span class="s2">&quot;2&quot;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Opening tunnel from </span><span class="si">{</span><span class="n">hostname</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">executor_hostname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_ssh_proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">ssh_cmd</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.4</span><span class="p">)</span>  <span class="c1"># Need to wait... -&gt; Use single Task comm at beginning?</span>
    <span class="k">return</span> <span class="n">local_socket_path</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="execution.ipc.SocketCommunicator._unpack_messages" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">_unpack_messages</span><span class="p">(</span><span class="n">data</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Unpacks a byte stream into individual messages.</p>


<details class="messages-are-encoded-in-the-following-format" open>
  <summary>Messages are encoded in the following format</summary>
  <p><HEAD><SEP><len(msg)><SEP><msg><SEP><HEAD[::-1]></p>
</details>        <p>The items between &lt;&gt; are replaced as follows:
    - <HEAD>: A start marker
    - <SEP>: A separator for components of the message
    - <len(msg)>: The length of the message payload in bytes.
    - <msg>: The message payload in bytes
    - <HEAD[::-1]>: The start marker in reverse to indicate the end.</p>
<p>Partial messages (a series of bytes which cannot be converted to a full
message) are stored for later. An attempt is made to reconstruct the
message with the next call to this method.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>data</code></td>
            <td>
                  <code>bytes</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A raw byte stream containing anywhere from a partial
message to multiple full messages.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>lute/execution/ipc.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">_unpack_messages</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Unpacks a byte stream into individual messages.</span>

<span class="sd">    Messages are encoded in the following format:</span>
<span class="sd">             &lt;HEAD&gt;&lt;SEP&gt;&lt;len(msg)&gt;&lt;SEP&gt;&lt;msg&gt;&lt;SEP&gt;&lt;HEAD[::-1]&gt;</span>
<span class="sd">    The items between &lt;&gt; are replaced as follows:</span>
<span class="sd">        - &lt;HEAD&gt;: A start marker</span>
<span class="sd">        - &lt;SEP&gt;: A separator for components of the message</span>
<span class="sd">        - &lt;len(msg)&gt;: The length of the message payload in bytes.</span>
<span class="sd">        - &lt;msg&gt;: The message payload in bytes</span>
<span class="sd">        - &lt;HEAD[::-1]&gt;: The start marker in reverse to indicate the end.</span>

<span class="sd">    Partial messages (a series of bytes which cannot be converted to a full</span>
<span class="sd">    message) are stored for later. An attempt is made to reconstruct the</span>
<span class="sd">    message with the next call to this method.</span>

<span class="sd">    Args:</span>
<span class="sd">        data (bytes): A raw byte stream containing anywhere from a partial</span>
<span class="sd">            message to multiple full messages.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">msg</span><span class="p">:</span> <span class="n">Message</span>
    <span class="n">working_data</span><span class="p">:</span> <span class="nb">bytes</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_partial_msg</span><span class="p">:</span>
        <span class="c1"># Concatenate the previous partial message to the beginning</span>
        <span class="n">working_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_partial_msg</span> <span class="o">+</span> <span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_partial_msg</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">working_data</span> <span class="o">=</span> <span class="n">data</span>
    <span class="k">while</span> <span class="n">working_data</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Message encoding: &lt;HEAD&gt;&lt;SEP&gt;&lt;len&gt;&lt;SEP&gt;&lt;msg&gt;&lt;SEP&gt;&lt;HEAD[::-1]&gt;</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">working_data</span><span class="o">.</span><span class="n">find</span><span class="p">(</span>
                <span class="n">SocketCommunicator</span><span class="o">.</span><span class="n">MSG_SEP</span> <span class="o">+</span> <span class="n">SocketCommunicator</span><span class="o">.</span><span class="n">MSG_HEAD</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">msg_parts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">bytes</span><span class="p">]</span> <span class="o">=</span> <span class="n">working_data</span><span class="p">[:</span><span class="n">end</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span>
                <span class="n">SocketCommunicator</span><span class="o">.</span><span class="n">MSG_SEP</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg_parts</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_partial_msg</span> <span class="o">=</span> <span class="n">working_data</span>
                <span class="k">break</span>

            <span class="n">cmd</span><span class="p">:</span> <span class="nb">bytes</span>
            <span class="n">nbytes</span><span class="p">:</span> <span class="nb">bytes</span>
            <span class="n">raw_msg</span><span class="p">:</span> <span class="nb">bytes</span>
            <span class="n">cmd</span><span class="p">,</span> <span class="n">nbytes</span><span class="p">,</span> <span class="n">raw_msg</span> <span class="o">=</span> <span class="n">msg_parts</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">raw_msg</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nbytes</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_partial_msg</span> <span class="o">=</span> <span class="n">working_data</span>
                <span class="k">break</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">raw_msg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_msg_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">pickle</span><span class="o">.</span><span class="n">UnpicklingError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_partial_msg</span> <span class="o">=</span> <span class="n">working_data</span>
            <span class="k">break</span>
        <span class="k">if</span> <span class="n">end</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">working_data</span><span class="p">):</span>
            <span class="c1"># Add len(SEP+HEAD) since end marks the start of &lt;SEP&gt;&lt;HEAD[::-1]</span>
            <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
                <span class="n">SocketCommunicator</span><span class="o">.</span><span class="n">MSG_SEP</span> <span class="o">+</span> <span class="n">SocketCommunicator</span><span class="o">.</span><span class="n">MSG_HEAD</span>
            <span class="p">)</span>
            <span class="n">working_data</span> <span class="o">=</span> <span class="n">working_data</span><span class="p">[</span><span class="n">end</span> <span class="o">+</span> <span class="n">offset</span> <span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">working_data</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="execution.ipc.SocketCommunicator._write_socket" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">_write_socket</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Sends data over a socket from the 'client' (Task) side.</p>


<details class="messages-are-encoded-in-the-following-format" open>
  <summary>Messages are encoded in the following format</summary>
  <p><HEAD><SEP><len(msg)><SEP><msg><SEP><HEAD[::-1]></p>
</details>        <p>The items between &lt;&gt; are replaced as follows:
    - <HEAD>: A start marker
    - <SEP>: A separator for components of the message
    - <len(msg)>: The length of the message payload in bytes.
    - <msg>: The message payload in bytes
    - <HEAD[::-1]>: The start marker in reverse to indicate the end.</p>
<p>This structure is used for decoding the message on the other end.</p>

            <details class="quote">
              <summary>Source code in <code>lute/execution/ipc.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">_write_socket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">Message</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Sends data over a socket from the &#39;client&#39; (Task) side.</span>

<span class="sd">    Messages are encoded in the following format:</span>
<span class="sd">             &lt;HEAD&gt;&lt;SEP&gt;&lt;len(msg)&gt;&lt;SEP&gt;&lt;msg&gt;&lt;SEP&gt;&lt;HEAD[::-1]&gt;</span>
<span class="sd">    The items between &lt;&gt; are replaced as follows:</span>
<span class="sd">        - &lt;HEAD&gt;: A start marker</span>
<span class="sd">        - &lt;SEP&gt;: A separator for components of the message</span>
<span class="sd">        - &lt;len(msg)&gt;: The length of the message payload in bytes.</span>
<span class="sd">        - &lt;msg&gt;: The message payload in bytes</span>
<span class="sd">        - &lt;HEAD[::-1]&gt;: The start marker in reverse to indicate the end.</span>

<span class="sd">    This structure is used for decoding the message on the other end.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="n">cmd</span><span class="p">:</span> <span class="nb">bytes</span> <span class="o">=</span> <span class="n">SocketCommunicator</span><span class="o">.</span><span class="n">MSG_HEAD</span>
    <span class="n">size</span><span class="p">:</span> <span class="nb">bytes</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">end</span><span class="p">:</span> <span class="nb">bytes</span> <span class="o">=</span> <span class="n">SocketCommunicator</span><span class="o">.</span><span class="n">MSG_HEAD</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">sep</span><span class="p">:</span> <span class="nb">bytes</span> <span class="o">=</span> <span class="n">SocketCommunicator</span><span class="o">.</span><span class="n">MSG_SEP</span>
    <span class="n">packed_msg</span><span class="p">:</span> <span class="nb">bytes</span> <span class="o">=</span> <span class="n">cmd</span> <span class="o">+</span> <span class="n">sep</span> <span class="o">+</span> <span class="n">size</span> <span class="o">+</span> <span class="n">sep</span> <span class="o">+</span> <span class="n">data</span> <span class="o">+</span> <span class="n">sep</span> <span class="o">+</span> <span class="n">end</span>
    <span class="k">if</span> <span class="n">USE_ZMQ</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data_socket</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">packed_msg</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data_socket</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">packed_msg</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="execution.ipc.SocketCommunicator.delayed_setup" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">delayed_setup</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Delays the creation of socket objects.</p>
<p>The Executor initializes the Communicator when it is created. Since
all Executors are created and available at once we want to delay
acquisition of socket resources until a single Executor is ready
to use them.</p>

            <details class="quote">
              <summary>Source code in <code>lute/execution/ipc.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">delayed_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Delays the creation of socket objects.</span>

<span class="sd">    The Executor initializes the Communicator when it is created. Since</span>
<span class="sd">    all Executors are created and available at once we want to delay</span>
<span class="sd">    acquisition of socket resources until a single Executor is ready</span>
<span class="sd">    to use them.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_data_socket</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">,</span> <span class="n">zmq</span><span class="o">.</span><span class="n">sugar</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">Socket</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">USE_ZMQ</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">desc</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Communicates using ZMQ through TCP or Unix sockets.&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="p">:</span> <span class="n">zmq</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">Context</span> <span class="o">=</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Context</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data_socket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_socket_zmq</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">desc</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Communicates through a TCP or Unix socket.&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data_socket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_socket_raw</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data_socket</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="n">SocketCommunicator</span><span class="o">.</span><span class="n">ACCEPT_TIMEOUT</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_party</span> <span class="o">==</span> <span class="n">Party</span><span class="o">.</span><span class="n">EXECUTOR</span><span class="p">:</span>
        <span class="c1"># Executor created first so we can define the hostname env variable</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;LUTE_EXECUTOR_HOST&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()</span>
        <span class="c1"># Setup reader thread</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reader_thread</span><span class="p">:</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span>
            <span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_read_socket</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_msg_queue</span><span class="p">:</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_partial_msg</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bytes</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_thread</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reader_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Only used by Party.TASK</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_use_ssh_tunnel</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ssh_proc</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_local_socket_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="execution.ipc.SocketCommunicator.read" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">read</span><span class="p">(</span><span class="n">proc</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Return a message from the queue if available.</p>
<p>Socket(s) are continuously monitored, and read from when new data is
available.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>proc</code></td>
            <td>
                  <code><span title="subprocess.Popen">Popen</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The process to read from. Provided for
compatibility with other Communicator subtypes. Is ignored.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>msg</code></td>            <td>
                  <code><span title="execution.ipc.Message">Message</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The message read, containing contents and signal.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>lute/execution/ipc.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proc</span><span class="p">:</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Message</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return a message from the queue if available.</span>

<span class="sd">    Socket(s) are continuously monitored, and read from when new data is</span>
<span class="sd">    available.</span>

<span class="sd">    Args:</span>
<span class="sd">        proc (subprocess.Popen): The process to read from. Provided for</span>
<span class="sd">            compatibility with other Communicator subtypes. Is ignored.</span>

<span class="sd">    Returns:</span>
<span class="sd">         msg (Message): The message read, containing contents and signal.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">msg</span><span class="p">:</span> <span class="n">Message</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_msg_queue</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">SocketCommunicator</span><span class="o">.</span><span class="n">ACCEPT_TIMEOUT</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">Message</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">msg</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="execution.ipc.SocketCommunicator.write" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">write</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Send a single Message.</p>
<p>The entire Message (signal and contents) is serialized and sent through
a connection over Unix socket.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>msg</code></td>
            <td>
                  <code><span title="execution.ipc.Message">Message</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The Message to send.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>lute/execution/ipc.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">Message</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Send a single Message.</span>

<span class="sd">    The entire Message (signal and contents) is serialized and sent through</span>
<span class="sd">    a connection over Unix socket.</span>

<span class="sd">    Args:</span>
<span class="sd">        msg (Message): The Message to send.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_write_socket</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      © 2024 LCLS
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../..", "features": [], "search": "../../../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.525ec568.min.js"></script>
      
    
  </body>
</html>