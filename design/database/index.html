<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="GFD, VM" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Database - LUTE</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
        <link href="../../assets/_mkdocstrings.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Database";
        var mkdocs_page_input_path = "design/database.md";
        var mkdocs_page_url = null;
      </script>
    
    <script src="../../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> LUTE
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../usage/">Quick Start</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Walkthroughs</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../tutorial/new_task/">Creating a new Task</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../tutorial/creating_workflows/">Creating a new Workflow</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Source Code</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../source/managed_tasks/">managed_tasks</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="#">execution</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../source/execution/executor/">executor</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../source/execution/ipc/">ipc</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../source/execution/debug_utils/">debug_utils</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="#">tasks</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../source/tasks/task/">task</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../source/tasks/dataclasses/">dataclasses</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../source/tasks/sfx_find_peaks/">sfx_find_peaks</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../source/tasks/sfx_index/">sfx_index</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../source/tasks/test/">test</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="#">io</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="#">models</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../source/io/models/base/">base</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../source/io/models/sfx_find_peaks/">sfx_find_peaks</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../source/io/models/sfx_index/">sfx_index</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../source/io/models/sfx_merge/">sfx_merge</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../source/io/models/sfx_solve/">sfx_solve</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../source/io/models/smd/">smd</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../source/io/models/tests/">tests</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../source/io/config/">config</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../source/io/db/">db</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../source/io/_sqlite/">_sqlite</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../source/io/elog/">elog</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../source/io/exceptions/">exceptions</a>
                </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Design and Specifications</span></p>
              <ul class="current">
                  <li class="toctree-l1 current"><a class="reference internal current" href="./">Database</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#basic-outline">Basic Outline</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#gen_cfg-table">gen_cfg table</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#column-descriptions">Column descriptions</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#exec_cfg-table">exec_cfg table</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#column-descriptions_1">Column descriptions</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#task-tables">Task tables</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#column-descriptions_2">Column descriptions</a>
    </li>
        </ul>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#api">API</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#write">Write</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#read">Read</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#utilities">Utilities</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#scripts">Scripts</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#tui-and-gui">TUI and GUI</a>
    </li>
        </ul>
    </li>
    </ul>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">LUTE</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" alt="Docs"></a> &raquo;</li>
          <li>Design and Specifications &raquo;</li>
      <li>Database</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/slac-lcls/lute/edit/master/docs/design/database.md" class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="lute-configuration-database-specification">LUTE Configuration Database Specification</h1>
<p><strong>Date:</strong> 2024-02-12
<strong>VERSION:</strong> v0.1</p>
<h2 id="basic-outline">Basic Outline</h2>
<ul>
<li>The backend database will be sqlite, using the standard Python library.</li>
<li>A high-level API is provided, so if needed, the backend database can be changed without affecting <code>Executor</code> level code.</li>
<li>One LUTE database is created per working directory for this iteration of the database. Note that this database is independent of any database used by a workflow manager (e.g. Airflow) to manage task execution order.</li>
<li>Each database has the following tables:</li>
<li>1 table for <code>Executor</code> configuration</li>
<li>1 table for general task configuration (i.e., <code>lute.io.config.AnalysisHeader</code>)</li>
<li>1 table <strong>PER</strong> <code>Task</code><ul>
<li>Executor and general configuration is shared between <code>Task</code> tables by pointing/linking to the entry ids in the above two tables.</li>
<li>Multiple experiments can reside in the same table, although in practice this is unlikely to occur in production as the working directory will most likely change between experiments.</li>
</ul>
</li>
</ul>
<h3 id="gen_cfg-table"><code>gen_cfg</code> table</h3>
<p>The general configuration table contains entries which may be shared between multiple <code>Task</code>s. The format of the table is:</p>
<table>
<thead>
<tr>
<th align="center">id</th>
<th align="center">title</th>
<th align="center">experiment</th>
<th align="center">run</th>
<th align="center">date</th>
<th align="center">lute_version</th>
<th align="center">task_timeout</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">2</td>
<td align="center">"My experiment desc"</td>
<td align="center">"EXPx00000</td>
<td align="center">1</td>
<td align="center">YYYY/MM/DD</td>
<td align="center">0.1</td>
<td align="center">6000</td>
</tr>
<tr>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
</tr>
</tbody>
</table>
<p>These parameters are extracted from the <code>TaskParameters</code> object. Each of those contains an <code>AnalysisHeader</code> object stored in the <code>lute_config</code> variable. For a given experimental run, this value will be shared across any <code>Task</code>s that are executed.</p>
<h4 id="column-descriptions">Column descriptions</h4>
<table>
<thead>
<tr>
<th align="center"><strong>Column</strong></th>
<th align="center"><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td align="center"><code>id</code></td>
<td align="center">ID of the entry in this table.</td>
</tr>
<tr>
<td align="center"><code>title</code></td>
<td align="center">Arbitrary description/title of the purpose of analysis. E.g. what kind of experiment is being conducted</td>
</tr>
<tr>
<td align="center"><code>experiment</code></td>
<td align="center">LCLS Experiment. Can be a placeholder if debugging, etc.</td>
</tr>
<tr>
<td align="center"><code>run</code></td>
<td align="center">LCLS Acquisition run. Can be a placeholder if debugging, testing, etc.</td>
</tr>
<tr>
<td align="center"><code>date</code></td>
<td align="center">Date the configuration file was first setup.</td>
</tr>
<tr>
<td align="center"><code>lute_version</code></td>
<td align="center">Version of the codebase being used to execute <code>Task</code>s.</td>
</tr>
<tr>
<td align="center"><code>task_timeout</code></td>
<td align="center">The maximum amount of time in seconds that a <code>Task</code> can run before being cancelled.</td>
</tr>
<tr>
<td align="center"></td>
<td align="center"></td>
</tr>
</tbody>
</table>
<h3 id="exec_cfg-table"><code>exec_cfg</code> table</h3>
<p>The <code>Executor</code> table contains information on the environment provided to the <code>Executor</code> for <code>Task</code> execution, the polling interval used for IPC between the <code>Task</code> and <code>Executor</code> and information on the communicator protocols used for IPC. This information can be shared between <code>Task</code>s or between experimental runs, but not necessarily every <code>Task</code> of a given run will use exactly the same <code>Executor</code> configuration and environment.</p>
<table>
<thead>
<tr>
<th align="center">id</th>
<th align="center">env</th>
<th align="center">poll_interval</th>
<th align="center">communicator_desc</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">2</td>
<td align="center">"VAR1=val1;VAR2=val2"</td>
<td align="center">0.1</td>
<td align="center">"PipeCommunicator...;SocketCommunicator..."</td>
</tr>
<tr>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
</tr>
</tbody>
</table>
<h4 id="column-descriptions_1">Column descriptions</h4>
<table>
<thead>
<tr>
<th align="center"><strong>Column</strong></th>
<th align="center"><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td align="center"><code>id</code></td>
<td align="center">ID of the entry in this table.</td>
</tr>
<tr>
<td align="center"><code>env</code></td>
<td align="center">Execution environment used by the Executor and by proxy any Tasks submitted by an Executor matching this entry. Environment is stored as a string with variables delimited by ";"</td>
</tr>
<tr>
<td align="center"><code>poll_interval</code></td>
<td align="center">Polling interval used for Task monitoring.</td>
</tr>
<tr>
<td align="center"><code>communicator_desc</code></td>
<td align="center">Description of the Communicators used.</td>
</tr>
<tr>
<td align="center"></td>
<td align="center"></td>
</tr>
</tbody>
</table>
<p><strong>NOTE</strong>: The <code>env</code> column currently only stores variables related to <code>SLURM</code> or <code>LUTE</code> itself.</p>
<h3 id="task-tables"><code>Task</code> tables</h3>
<p>For every <code>Task</code> a table of the following format will be created. The exact number of columns will depend on the specific <code>Task</code>, as the number of parameters can vary between them, and each parameter gets its own column. Within a table, multiple experiments and runs can coexist. The experiment and run are not recorded directly. Instead the first two columns point to the id of entries in the general configuration and <code>Executor</code> tables respectively. The general configuration table entry will contain the experiment and run information.</p>
<table>
<thead>
<tr>
<th align="center">id</th>
<th align="center">timestamp</th>
<th align="center">gen_cfg_id</th>
<th align="center">exec_cfg_id</th>
<th align="center">P1</th>
<th align="center">P2</th>
<th align="center">...</th>
<th align="center">Pn</th>
<th align="center">result.task_status</th>
<th align="center">result.summary</th>
<th align="center">result.payload</th>
<th align="center">result.impl_schemas</th>
<th align="center">valid_flag</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">2</td>
<td align="center">"YYYY-MM-DD HH:MM:SS"</td>
<td align="center">1</td>
<td align="center">1</td>
<td align="center">1</td>
<td align="center">2</td>
<td align="center">...</td>
<td align="center">3</td>
<td align="center">"COMPLETED"</td>
<td align="center">"Summary"</td>
<td align="center">"XYZ"</td>
<td align="center">"schema1;schema3;"</td>
<td align="center">1</td>
</tr>
<tr>
<td align="center">3</td>
<td align="center">"YYYY-MM-DD HH:MM:SS"</td>
<td align="center">1</td>
<td align="center">1</td>
<td align="center">3</td>
<td align="center">1</td>
<td align="center">...</td>
<td align="center">4</td>
<td align="center">"FAILED"</td>
<td align="center">"Summary"</td>
<td align="center">"XYZ"</td>
<td align="center">"schema1;schema3;"</td>
<td align="center">0</td>
</tr>
<tr>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
</tr>
</tbody>
</table>
<h4 id="column-descriptions_2">Column descriptions</h4>
<table>
<thead>
<tr>
<th align="center"><strong>Column</strong></th>
<th align="center"><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td align="center"><code>id</code></td>
<td align="center">ID of the entry in this table.</td>
</tr>
<tr>
<td align="center"><code>CURRENT_TIMESTAMP</code></td>
<td align="center">Full timestamp for the entry.</td>
</tr>
<tr>
<td align="center"><code>gen_cfg_id</code></td>
<td align="center">ID of the entry in the general config table that applies to this <code>Task</code> entry. That table has, e.g., experiment and run number.</td>
</tr>
<tr>
<td align="center"><code>exec_cfg_id</code></td>
<td align="center">The ID of the entry in the <code>Executor</code> table which applies to this <code>Task</code> entry.</td>
</tr>
<tr>
<td align="center"><code>P1</code> - <code>Pn</code></td>
<td align="center">The specific parameters of the <code>Task</code>. The <code>P{1..n}</code> are replaced by the actual parameter names.</td>
</tr>
<tr>
<td align="center"><code>task_status</code></td>
<td align="center">Reported exit status of the <code>Task</code>. Note that the output may still be labeled invalid by the <code>valid_flag</code> (see below).</td>
</tr>
<tr>
<td align="center"><code>summary</code></td>
<td align="center">Short text summary of the <code>Task</code> result. This is provided by the <code>Task</code>, or sometimes the <code>Executor</code>.</td>
</tr>
<tr>
<td align="center"><code>payload</code></td>
<td align="center">Full description of result from the <code>Task</code>. If the object is incompatible with the database, will instead be a pointer to where it can be found.</td>
</tr>
<tr>
<td align="center"><code>impl_schemas</code></td>
<td align="center">A string of semi-colon separated schema(s) implemented by the <code>Task</code>. Schemas describe conceptually the type output the <code>Task</code> produces.</td>
</tr>
<tr>
<td align="center"><code>valid_flag</code></td>
<td align="center">A boolean flag for whether the result is valid. May be <code>0</code> (False) if e.g., data is missing, or corrupt, or reported status is failed.</td>
</tr>
<tr>
<td align="center"></td>
<td align="center"></td>
</tr>
</tbody>
</table>
<p><strong>NOTE:</strong> The <code>payload</code> is distinct from the output files. Payloads are an optional summary of the results provided by the <code>Task</code>. E.g. this may include graphical descriptions of results (plots, figures, etc.). The output files themselves, if they exist, will most likely be pointed to be an output file parameter in one of the columns <code>P{1...n}</code></p>
<h2 id="api">API</h2>
<p>This API is intended to be used at the <code>Executor</code> level, with some calls intended to provide default values for Pydantic models. Utilities for reading and inspecting the database outside of normal <code>Task</code> execution are addressed in the following subheader.</p>
<h3 id="write">Write</h3>
<ul>
<li><code>record_analysis_db(cfg: DescribedAnalysis) -&gt; None</code>: Writes the configuration to the backend database.</li>
<li>...</li>
<li>...</li>
</ul>
<h3 id="read">Read</h3>
<ul>
<li><code>read_latest_db_entry(db_dir: str, task_name: str, param: str) -&gt; Any</code>: Retrieve the most recent entry from a database for a specific Task.</li>
<li>...</li>
<li>...</li>
</ul>
<h2 id="utilities">Utilities</h2>
<h3 id="scripts">Scripts</h3>
<ul>
<li><code>invalidate_entry</code>: Marks a database entry as invalid. Common reason to use this is if data has been deleted, or found to be corrupted.</li>
<li>...</li>
</ul>
<h3 id="tui-and-gui">TUI and GUI</h3>
<ul>
<li><code>dbview</code>: TUI for database inspection. Read only.</li>
<li>...</li>
</ul>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../../source/io/exceptions/" class="btn btn-neutral float-left" title="exceptions"><span class="icon icon-circle-arrow-left"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
      <p>© 2024 LCLS</p>
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/slac-lcls/lute" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
      <span><a href="../../source/io/exceptions/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
  </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme_extra.js" defer></script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
